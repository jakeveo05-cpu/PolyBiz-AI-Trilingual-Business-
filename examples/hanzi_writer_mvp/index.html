<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyBiz AI - Hanzi Writer MVP</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; color: #fff; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; font-size: 1.8em; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }
        
        /* Performance Monitor */
        #perf-monitor {
            position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8);
            padding: 15px; border-radius: 10px; font-family: monospace; font-size: 12px;
            z-index: 1000; min-width: 200px;
        }
        .perf-row { display: flex; justify-content: space-between; margin: 5px 0; }
        .perf-label { color: #888; }
        .perf-value { color: #4ade80; font-weight: bold; }
        .perf-warning { color: #fbbf24; }
        .perf-danger { color: #ef4444; }
</style>
</head>
<body>
    <div class="container">
        <h1>ğŸ€„ PolyBiz AI - Hanzi Writer MVP</h1>
        <p class="subtitle">Test hiá»‡u nÄƒng Air Writing + Character Animation</p>
        
        <!-- Performance Monitor -->
        <div id="perf-monitor">
            <div style="font-weight:bold; margin-bottom:10px; color:#60a5fa;">ğŸ“Š Performance</div>
            <div class="perf-row"><span class="perf-label">FPS:</span><span id="fps" class="perf-value">--</span></div>
            <div class="perf-row"><span class="perf-label">Memory:</span><span id="memory" class="perf-value">--</span></div>
            <div class="perf-row"><span class="perf-label">CPU Load:</span><span id="cpu" class="perf-value">--</span></div>
            <div class="perf-row"><span class="perf-label">Hand Track:</span><span id="hand-status" class="perf-value">OFF</span></div>
            <hr style="border-color:#333; margin:10px 0;">
            <div class="perf-row"><span class="perf-label">Browser:</span><span id="browser" class="perf-value">--</span></div>
            <div class="perf-row"><span class="perf-label">Screen:</span><span id="screen" class="perf-value">--</span></div>
        </div>
</body>
</html>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Character Display -->
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“š Há»c chá»¯</span>
                    <select id="char-select">
                        <option value="å¥½">å¥½ (hÇo) - Tá»‘t</option>
                        <option value="ä½ ">ä½  (nÇ) - Báº¡n</option>
                        <option value="æˆ‘">æˆ‘ (wÇ’) - TÃ´i</option>
                        <option value="ä»–">ä»– (tÄ) - Anh áº¥y</option>
                        <option value="æ˜¯">æ˜¯ (shÃ¬) - LÃ </option>
                        <option value="ä¸­">ä¸­ (zhÅng) - Giá»¯a</option>
                        <option value="å›½">å›½ (guÃ³) - NÆ°á»›c</option>
                        <option value="äºº">äºº (rÃ©n) - NgÆ°á»i</option>
                        <option value="å¤§">å¤§ (dÃ ) - Lá»›n</option>
                        <option value="å­¦">å­¦ (xuÃ©) - Há»c</option>
                    </select>
                </div>
                <div class="char-display">
                    <div id="character-target" class="hanzi-box"></div>
                    <div class="char-info">
                        <div id="char-pinyin" class="pinyin">hÇo</div>
                        <div id="char-meaning" class="meaning">Tá»‘t, ThÃ­ch</div>
                        <div id="char-radical" class="radical">Bá»™: å¥³ (ná»¯) + å­ (con)</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button id="btn-animate" class="btn btn-primary">â–¶ï¸ Animation</button>
                    <button id="btn-quiz" class="btn btn-success">âœï¸ Quiz Mode</button>
                </div>
            </div>

            <!-- Air Writing -->
            <div class="card">
                <div class="card-header">
                    <span>ğŸ¯ Air Writing <span style="background:#f59e0b;color:#000;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:5px;">BETA</span></span>
                    <span id="air-status" class="status-badge status-off">Camera OFF</span>
                </div>
                <div class="air-writing-area">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="draw-canvas"></canvas>
                    <div id="webcam-placeholder">
                        <div>ğŸ“¹</div>
                        <div>Click "Báº­t Camera" Ä‘á»ƒ báº¯t Ä‘áº§u</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button id="btn-camera" class="btn btn-primary">ğŸ“¹ Báº­t Camera</button>
                    <button id="btn-draw-toggle" class="btn btn-success" style="display:none;">âœï¸ Giá»¯ Ä‘á»ƒ váº½ (Space)</button>
                    <button id="btn-undo" class="btn btn-secondary">â†©ï¸ Undo</button>
                    <button id="btn-clear" class="btn btn-secondary">ğŸ—‘ï¸ XÃ³a</button>
                </div>
                <p style="font-size:11px;color:#888;margin-top:10px;text-align:center;">
                    Giá»¯ phÃ­m <kbd style="background:#333;padding:2px 6px;border-radius:3px;">Space</kbd> hoáº·c nÃºt "Giá»¯ Ä‘á»ƒ váº½" khi muá»‘n váº½
                </p>
            </div>

            <!-- Practice Canvas -->
            <div class="card">
                <div class="card-header">
                    <span>âœï¸ Luyá»‡n viáº¿t (Chuá»™t/Touch)</span>
                </div>
                <div id="practice-target" class="hanzi-box practice-box"></div>
                <div class="score-display">
                    <span>Äiá»ƒm: </span><span id="score">--</span>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="card results-card">
            <div class="card-header">ğŸ“ˆ Káº¿t quáº£ Test</div>
            <div id="test-results">
                <p>Nháº¥n cÃ¡c nÃºt Ä‘á»ƒ test tá»«ng tÃ­nh nÄƒng. Káº¿t quáº£ sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y.</p>
            </div>
            <button id="btn-full-test" class="btn btn-warning" style="margin-top:15px;">
                ğŸ§ª Cháº¡y Full Test (30 giÃ¢y)
            </button>
        </div>
    </div>

    <style>
        .main-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.05); border-radius: 15px;
            padding: 20px; backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; font-weight: bold; font-size: 1.1em;
        }
        .hanzi-box {
            width: 200px; height: 200px; margin: 0 auto;
            background: rgba(255,255,255,0.1); border-radius: 10px;
        }
        .practice-box { background: #fff; }
        .char-display { text-align: center; margin-bottom: 15px; }
        .char-info { margin-top: 15px; }
        .pinyin { font-size: 1.5em; color: #60a5fa; }
        .meaning { font-size: 1.2em; margin: 5px 0; }
        .radical { color: #888; font-size: 0.9em; }
        
        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            cursor: pointer; font-size: 14px; transition: all 0.2s;
        }
        .btn-primary { background: #3b82f6; color: #fff; }
        .btn-success { background: #22c55e; color: #fff; }
        .btn-secondary { background: #6b7280; color: #fff; }
        .btn-warning { background: #f59e0b; color: #000; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-active { background: #16a34a !important; transform: scale(0.95); box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        
        .status-badge {
            padding: 4px 10px; border-radius: 20px; font-size: 12px;
        }
        .status-off { background: #ef4444; }
        .status-on { background: #22c55e; }
        
        .air-writing-area {
            position: relative; width: 100%; aspect-ratio: 4/3;
            background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 15px;
        }
        #webcam {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.15;
            filter: grayscale(100%);
            transform: scaleX(-1); /* Mirror camera */
        }
        #draw-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        #webcam-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; color: #666; font-size: 14px;
        }
        #webcam-placeholder div:first-child { font-size: 48px; margin-bottom: 10px; }
        
        .score-display { text-align: center; margin-top: 15px; font-size: 1.2em; }
        #score { color: #4ade80; font-weight: bold; }
        
        .results-card { margin-top: 20px; }
        #test-results { 
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;
            font-family: monospace; font-size: 13px; line-height: 1.6;
            max-height: 300px; overflow-y: auto;
        }
        
        select {
            background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #444;
            padding: 5px 10px; border-radius: 5px;
        }
    </style>

    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <script>
        // ============ PERFORMANCE MONITOR ============
        const perfData = {
            fps: [], memory: [], cpuStart: 0, frameCount: 0, lastTime: performance.now()
        };

        function updatePerformance() {
            const now = performance.now();
            perfData.frameCount++;
            
            if (now - perfData.lastTime >= 1000) {
                const fps = Math.round(perfData.frameCount * 1000 / (now - perfData.lastTime));
                perfData.fps.push(fps);
                document.getElementById('fps').textContent = fps;
                document.getElementById('fps').className = 
                    fps >= 30 ? 'perf-value' : fps >= 15 ? 'perf-warning' : 'perf-danger';
                
                if (performance.memory) {
                    const memMB = Math.round(performance.memory.usedJSHeapSize / 1048576);
                    perfData.memory.push(memMB);
                    document.getElementById('memory').textContent = memMB + ' MB';
                    document.getElementById('memory').className = 
                        memMB < 100 ? 'perf-value' : memMB < 200 ? 'perf-warning' : 'perf-danger';
                }
                
                perfData.frameCount = 0;
                perfData.lastTime = now;
            }
            requestAnimationFrame(updatePerformance);
        }

        // Browser & Screen info
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            if (ua.includes('Chrome')) browser = 'Chrome';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Safari')) browser = 'Safari';
            else if (ua.includes('Edge')) browser = 'Edge';
            
            document.getElementById('browser').textContent = browser;
            document.getElementById('screen').textContent = 
                `${window.screen.width}x${window.screen.height}`;
            
            if (!performance.memory) {
                document.getElementById('memory').textContent = 'N/A';
            }
        }
</script>

    <script>
        // ============ HANZI WRITER ============
        let writer = null;
        let quizWriter = null;
        const charData = {
            'å¥½': { pinyin: 'hÇo', meaning: 'Tá»‘t, ThÃ­ch', radical: 'å¥³ (ná»¯) + å­ (con)' },
            'ä½ ': { pinyin: 'nÇ', meaning: 'Báº¡n', radical: 'äº» (ngÆ°á»i) + å°”' },
            'æˆ‘': { pinyin: 'wÇ’', meaning: 'TÃ´i', radical: 'æ‰‹ (tay) + æˆˆ (giÃ¡o)' },
            'ä»–': { pinyin: 'tÄ', meaning: 'Anh áº¥y', radical: 'äº» (ngÆ°á»i) + ä¹Ÿ' },
            'æ˜¯': { pinyin: 'shÃ¬', meaning: 'LÃ ', radical: 'æ—¥ (máº·t trá»i) + æ­£' },
            'ä¸­': { pinyin: 'zhÅng', meaning: 'Giá»¯a, Trung', radical: 'ä¸¨ (nÃ©t sá»•) + å£' },
            'å›½': { pinyin: 'guÃ³', meaning: 'NÆ°á»›c, Quá»‘c gia', radical: 'å›— (bao vÃ¢y) + ç‰' },
            'äºº': { pinyin: 'rÃ©n', meaning: 'NgÆ°á»i', radical: 'äºº (ngÆ°á»i)' },
            'å¤§': { pinyin: 'dÃ ', meaning: 'Lá»›n, To', radical: 'å¤§ (lá»›n)' },
            'å­¦': { pinyin: 'xuÃ©', meaning: 'Há»c', radical: 'å­ (con) + å†–' }
        };

        function initHanziWriter(char) {
            document.getElementById('character-target').innerHTML = '';
            writer = HanziWriter.create('character-target', char, {
                width: 200, height: 200,
                padding: 5,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 200,
                strokeColor: '#3b82f6',
                radicalColor: '#ef4444',
                showOutline: true,
                showCharacter: true
            });
            
            const data = charData[char];
            document.getElementById('char-pinyin').textContent = data.pinyin;
            document.getElementById('char-meaning').textContent = data.meaning;
            document.getElementById('char-radical').textContent = 'Bá»™: ' + data.radical;
        }

        function initQuizWriter(char) {
            document.getElementById('practice-target').innerHTML = '';
            quizWriter = HanziWriter.create('practice-target', char, {
                width: 200, height: 200,
                padding: 5,
                showCharacter: false,
                showOutline: true,
                showHintAfterMisses: 3,
                highlightOnComplete: true,
                strokeColor: '#22c55e',
                drawingColor: '#3b82f6',
                outlineColor: '#ddd',
                highlightColor: '#4ade80'
            });
        }

        document.getElementById('btn-animate').addEventListener('click', () => {
            if (writer) writer.animateCharacter();
        });

        document.getElementById('btn-quiz').addEventListener('click', () => {
            const char = document.getElementById('char-select').value;
            initQuizWriter(char);
            quizWriter.quiz({
                onComplete: (data) => {
                    const score = Math.round((1 - data.totalMistakes / 10) * 100);
                    document.getElementById('score').textContent = Math.max(0, score) + '%';
                    logResult(`âœ… Quiz hoÃ n thÃ nh! Äiá»ƒm: ${Math.max(0, score)}%, Lá»—i: ${data.totalMistakes}`);
                }
            });
        });

        document.getElementById('char-select').addEventListener('change', (e) => {
            initHanziWriter(e.target.value);
            currentChar = e.target.value; // Cáº­p nháº­t chá»¯ máº«u air writing
            // XÃ³a nÃ©t cÅ© khi Ä‘á»•i chá»¯
            if (persistentCtx) {
                persistentCtx.clearRect(0, 0, persistentCanvas.width, persistentCanvas.height);
            }
        });
    </script>

    <script>
        // ============ AIR WRITING (MediaPipe) ============
        let camera = null;
        let hands = null;
        let isDrawing = false;
        let lastPoint = null;
        let persistentCanvas = null;
        let persistentCtx = null;
        let positionHistory = [];
        const SMOOTH_FACTOR = 8; // TÄƒng lÃªn Ä‘á»ƒ mÆ°á»£t hÆ¡n
        const MIN_MOVE_DISTANCE = 2; // Giáº£m xuá»‘ng Ä‘á»ƒ nÃ©t liá»n hÆ¡n
        let lastDrawTime = 0;
        const DRAW_INTERVAL = 12; // Nhanh hÆ¡n Ä‘á»ƒ báº¯t gÃ³c
        let currentChar = 'å¥½';
        let handDistance = 0;
        
        // Auto-connect settings
        const AUTO_CONNECT_DISTANCE = 30;
        const MAX_JUMP_DISTANCE = 80;
        let lastStrokeEnd = null;
        let strokeCount = 0;
        
        // Stroke history for undo
        let strokeHistory = [];
        let currentStroke = [];
        
        // Direction detection for corners
        let lastDirection = null;
        const CORNER_ANGLE_THRESHOLD = 45;
        
        // Grid bounds (sáº½ Ä‘Æ°á»£c set khi váº½)
        let gridBounds = { x: 0, y: 0, size: 280 };
        
        // Stability check
        let handStableFrames = 0;
        const STABLE_FRAMES_REQUIRED = 5;
        let lastHandPosition = null;
        
        // CHáº¾ Äá»˜ Váº¼ - dÃ¹ng phÃ­m Space hoáº·c nÃºt Ä‘á»ƒ toggle
        let drawingEnabled = false;
        
        const drawCanvas = document.getElementById('draw-canvas');
        const drawCtx = drawCanvas.getContext('2d');
        const video = document.getElementById('webcam');

        async function initCamera() {
            const placeholder = document.getElementById('webcam-placeholder');
            const statusBadge = document.getElementById('air-status');
            const handStatus = document.getElementById('hand-status');
            
            try {
                logResult('ğŸ“¹ Äang khá»Ÿi táº¡o camera...');
                
                hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                });
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1, // Full model cho chÃ­nh xÃ¡c hÆ¡n
                    minDetectionConfidence: 0.8,
                    minTrackingConfidence: 0.8
                });
                
                hands.onResults(onHandResults);
                
                camera = new Camera(video, {
                    onFrame: async () => {
                        await hands.send({ image: video });
                    },
                    width: 640,
                    height: 480
                });
                
                await camera.start();
                
                placeholder.style.display = 'none';
                statusBadge.textContent = 'Camera ON';
                statusBadge.className = 'status-badge status-on';
                handStatus.textContent = 'Tracking...';
                handStatus.className = 'perf-value';
                
                drawCanvas.width = 640;
                drawCanvas.height = 480;
                
                persistentCanvas = document.createElement('canvas');
                persistentCanvas.width = 640;
                persistentCanvas.height = 480;
                persistentCtx = persistentCanvas.getContext('2d');
                
                logResult('âœ… Camera Ä‘Ã£ báº­t!');
                logResult('ğŸ‘† Giá»¯ phÃ­m SPACE Ä‘á»ƒ váº½, tháº£ ra Ä‘á»ƒ nháº¥c bÃºt');
                logResult('ğŸ–ï¸ XÃ²e tay Ä‘á»ƒ xÃ³a');
                
                // Hiá»‡n nÃºt váº½
                document.getElementById('btn-draw-toggle').style.display = 'inline-block';
                
            } catch (err) {
                logResult('âŒ Lá»—i camera: ' + err.message);
                statusBadge.textContent = 'Lá»—i';
                statusBadge.className = 'status-badge status-off';
            }
        }

        function isFingerExtended(landmarks, fingerTip, fingerPip, fingerMcp) {
            return landmarks[fingerTip].y < landmarks[fingerPip].y && 
                   landmarks[fingerPip].y < landmarks[fingerMcp].y;
        }
        
        function isFingerFolded(landmarks, fingerTip, fingerPip) {
            // NgÃ³n tay gáº­p khi tip THáº¤P hÆ¡n pip (gáº§n lÃ²ng bÃ n tay)
            return landmarks[fingerTip].y > landmarks[fingerPip].y;
        }
        
        function detectGesture(landmarks) {
            // Kiá»ƒm tra tá»«ng ngÃ³n
            const indexTip = landmarks[8], indexPip = landmarks[6], indexMcp = landmarks[5];
            const middleTip = landmarks[12], middlePip = landmarks[10], middleMcp = landmarks[9];
            const ringTip = landmarks[16], ringPip = landmarks[14], ringMcp = landmarks[13];
            const pinkyTip = landmarks[20], pinkyPip = landmarks[18], pinkyMcp = landmarks[17];
            const thumbTip = landmarks[4], thumbIp = landmarks[3], thumbMcp = landmarks[2];
            
            // NgÃ³n trá» duá»—i tháº³ng hoÃ n toÃ n
            const indexStraight = indexTip.y < indexPip.y && indexPip.y < indexMcp.y;
            // NgÃ³n trá» gáº­p
            const indexFolded = indexTip.y > indexPip.y;
            
            // 3 ngÃ³n cÃ²n láº¡i gáº­p (náº¯m tay)
            const middleFolded = middleTip.y > middlePip.y;
            const ringFolded = ringTip.y > ringPip.y;
            const pinkyFolded = pinkyTip.y > pinkyPip.y;
            const othersFolded = middleFolded && ringFolded && pinkyFolded;
            
            // 4 ngÃ³n duá»—i (xÃ²e tay)
            const indexExtended = indexTip.y < indexMcp.y;
            const middleExtended = middleTip.y < middleMcp.y;
            const ringExtended = ringTip.y < ringMcp.y;
            const pinkyExtended = pinkyTip.y < pinkyMcp.y;
            const allExtended = indexExtended && middleExtended && ringExtended && pinkyExtended;
            
            // GESTURE 1: Váº¼ - Náº¯m tay + CHá»ˆ ngÃ³n trá» duá»—i tháº³ng
            if (indexStraight && othersFolded) {
                return 'DRAW';
            }
            
            // GESTURE 2: XÃ“A - XÃ²e cáº£ bÃ n tay (4 ngÃ³n duá»—i)
            if (allExtended) {
                return 'ERASE';
            }
            
            // GESTURE 3: NHáº¤C BÃšT - Náº¯m tay hoÃ n toÃ n (táº¥t cáº£ ngÃ³n gáº­p)
            if (indexFolded && othersFolded) {
                return 'LIFT';
            }
            
            // KhÃ´ng nháº­n diá»‡n Ä‘Æ°á»£c gesture chuáº©n
            return 'NONE';
        }
        
        function getHandOrientation(landmarks) {
            const wrist = landmarks[0];
            const middleMcp = landmarks[9];
            return middleMcp.y < wrist.y;
        }
        
        function smoothPosition(x, y) {
            positionHistory.push({ x, y, time: Date.now() });
            if (positionHistory.length > SMOOTH_FACTOR) {
                positionHistory.shift();
            }
            
            // TÃ­nh hÆ°á»›ng di chuyá»ƒn hiá»‡n táº¡i
            let currentDirection = null;
            if (positionHistory.length >= 2) {
                const prev = positionHistory[positionHistory.length - 2];
                const curr = positionHistory[positionHistory.length - 1];
                currentDirection = Math.atan2(curr.y - prev.y, curr.x - prev.x) * 180 / Math.PI;
            }
            
            // Kiá»ƒm tra cÃ³ Ä‘á»•i hÆ°á»›ng Ä‘á»™t ngá»™t khÃ´ng
            let isCorner = false;
            if (lastDirection !== null && currentDirection !== null) {
                let angleDiff = Math.abs(currentDirection - lastDirection);
                if (angleDiff > 180) angleDiff = 360 - angleDiff;
                isCorner = angleDiff > CORNER_ANGLE_THRESHOLD;
            }
            lastDirection = currentDirection;
            
            // Náº¿u lÃ  gÃ³c gáº¥p khÃºc, dÃ¹ng Ã­t smooth hÆ¡n
            const effectiveSmooth = isCorner ? 2 : SMOOTH_FACTOR;
            const recentPoints = positionHistory.slice(-effectiveSmooth);
            
            let totalWeight = 0;
            let avgX = 0, avgY = 0;
            recentPoints.forEach((p, i) => {
                const weight = i + 1;
                avgX += p.x * weight;
                avgY += p.y * weight;
                totalWeight += weight;
            });
            
            return { 
                x: avgX / totalWeight, 
                y: avgY / totalWeight,
                isCorner: isCorner
            };
        }

        function onHandResults(results) {
            // XÃ³a canvas
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
            
            // Váº½ grid Ã´ chá»¯ á»Ÿ giá»¯a
            const gridSize = 280;
            const gridX = (drawCanvas.width - gridSize) / 2;
            const gridY = (drawCanvas.height - gridSize) / 2 + 15;
            
            // LÆ°u grid bounds Ä‘á»ƒ check
            gridBounds = { x: gridX, y: gridY, size: gridSize };
            
            // Ná»n Ã´ chá»¯ - sÃ¡ng hÆ¡n
            drawCtx.fillStyle = 'rgba(255, 255, 255, 0.08)';
            drawCtx.fillRect(gridX, gridY, gridSize, gridSize);
            
            // Viá»n Ã´ chá»¯ - Ä‘áº­m hÆ¡n
            drawCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            drawCtx.lineWidth = 3;
            drawCtx.strokeRect(gridX, gridY, gridSize, gridSize);
            
            // ÄÆ°á»ng chÃ©o (ç±³å­—æ ¼)
            drawCtx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
            drawCtx.lineWidth = 1;
            drawCtx.setLineDash([5, 5]);
            
            // ÄÆ°á»ng ngang giá»¯a
            drawCtx.beginPath();
            drawCtx.moveTo(gridX, gridY + gridSize/2);
            drawCtx.lineTo(gridX + gridSize, gridY + gridSize/2);
            drawCtx.stroke();
            
            // ÄÆ°á»ng dá»c giá»¯a
            drawCtx.beginPath();
            drawCtx.moveTo(gridX + gridSize/2, gridY);
            drawCtx.lineTo(gridX + gridSize/2, gridY + gridSize);
            drawCtx.stroke();
            
            // ÄÆ°á»ng chÃ©o
            drawCtx.beginPath();
            drawCtx.moveTo(gridX, gridY);
            drawCtx.lineTo(gridX + gridSize, gridY + gridSize);
            drawCtx.stroke();
            
            drawCtx.beginPath();
            drawCtx.moveTo(gridX + gridSize, gridY);
            drawCtx.lineTo(gridX, gridY + gridSize);
            drawCtx.stroke();
            
            drawCtx.setLineDash([]); // Reset dash
            
            // Váº½ chá»¯ máº«u má» á»Ÿ giá»¯a
            if (currentChar) {
                drawCtx.font = `${gridSize * 0.8}px "Noto Sans SC", "Microsoft YaHei", sans-serif`;
                drawCtx.fillStyle = 'rgba(100, 150, 255, 0.15)';
                drawCtx.textAlign = 'center';
                drawCtx.textBaseline = 'middle';
                drawCtx.fillText(currentChar, gridX + gridSize/2, gridY + gridSize/2 + 10);
            }
            
            // Váº½ láº¡i nÃ©t Ä‘Ã£ lÆ°u
            if (persistentCtx) {
                drawCtx.drawImage(persistentCanvas, 0, 0);
            }
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // TÃ­nh khoáº£ng cÃ¡ch tay (dá»±a vÃ o kÃ­ch thÆ°á»›c bÃ n tay trÃªn mÃ n hÃ¬nh)
                const wrist = landmarks[0];
                const middleTip = landmarks[12];
                handDistance = Math.sqrt(
                    Math.pow(middleTip.x - wrist.x, 2) + 
                    Math.pow(middleTip.y - wrist.y, 2)
                );
                
                // Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n khoáº£ng cÃ¡ch
                let distanceStatus = '';
                let distanceColor = '#888';
                if (handDistance < 0.15) {
                    distanceStatus = 'ğŸ“ ÄÆ°a tay Láº I Gáº¦N camera hÆ¡n';
                    distanceColor = '#ef4444';
                } else if (handDistance > 0.35) {
                    distanceStatus = 'ğŸ“ ÄÆ°a tay RA XA camera hÆ¡n';
                    distanceColor = '#ef4444';
                } else {
                    distanceStatus = 'âœ… Khoáº£ng cÃ¡ch tá»‘t';
                    distanceColor = '#22c55e';
                }
                
                // Váº½ hÆ°á»›ng dáº«n khoáº£ng cÃ¡ch
                drawCtx.font = '14px sans-serif';
                drawCtx.fillStyle = distanceColor;
                drawCtx.textAlign = 'center';
                drawCtx.fillText(distanceStatus, drawCanvas.width/2, 25);
                
                // Nháº­n diá»‡n gesture
                const gesture = detectGesture(landmarks);
                const handUp = getHandOrientation(landmarks);
                
                const indexTip = landmarks[8];
                const palmCenter = landmarks[9];
                const rawX = (1 - indexTip.x) * drawCanvas.width;
                const rawY = indexTip.y * drawCanvas.height;
                const palmX = (1 - palmCenter.x) * drawCanvas.width;
                const palmY = palmCenter.y * drawCanvas.height;
                
                const smoothed = smoothPosition(rawX, rawY);
                const x = smoothed.x;
                const y = smoothed.y;
                
                // Kiá»ƒm tra tay cÃ³ trong vÃ¹ng váº½ khÃ´ng
                const inGrid = x >= gridBounds.x && x <= gridBounds.x + gridBounds.size &&
                               y >= gridBounds.y && y <= gridBounds.y + gridBounds.size;
                
                // Kiá»ƒm tra xÃ²e tay Ä‘á»ƒ xÃ³a
                if (gesture === 'ERASE' && inGrid) {
                    if (persistentCtx) {
                        persistentCtx.globalCompositeOperation = 'destination-out';
                        persistentCtx.beginPath();
                        persistentCtx.arc(palmX, palmY, 50, 0, 2 * Math.PI);
                        persistentCtx.fill();
                        persistentCtx.globalCompositeOperation = 'source-over';
                    }
                    
                    drawCtx.beginPath();
                    drawCtx.arc(palmX, palmY, 50, 0, 2 * Math.PI);
                    drawCtx.strokeStyle = '#ef4444';
                    drawCtx.lineWidth = 3;
                    drawCtx.stroke();
                    drawCtx.fillStyle = 'rgba(239, 68, 68, 0.2)';
                    drawCtx.fill();
                    
                    lastPoint = null;
                    isDrawing = false;
                    document.getElementById('hand-status').textContent = 'ğŸ§¹ Äang xÃ³a';
                    document.getElementById('hand-status').className = 'perf-danger';
                    return;
                }
                
                // Váº¼ CHá»ˆ KHI GIá»® PHÃM SPACE
                if (drawingEnabled && inGrid) {
                    const now = Date.now();
                    
                    if (!lastPoint) {
                        lastPoint = { x, y };
                        lastDrawTime = now;
                        strokeCount++;
                        currentStroke = [{ x, y }];
                    }
                    
                    if (lastPoint && persistentCtx && (now - lastDrawTime) >= DRAW_INTERVAL) {
                        const dist = Math.sqrt(Math.pow(x - lastPoint.x, 2) + Math.pow(y - lastPoint.y, 2));
                        
                        if (dist >= MIN_MOVE_DISTANCE && dist < MAX_JUMP_DISTANCE) {
                            persistentCtx.beginPath();
                            persistentCtx.moveTo(lastPoint.x, lastPoint.y);
                            persistentCtx.lineTo(x, y);
                            persistentCtx.strokeStyle = '#3b82f6';
                            persistentCtx.lineWidth = 5;
                            persistentCtx.lineCap = 'round';
                            persistentCtx.lineJoin = 'round';
                            persistentCtx.stroke();
                            
                            currentStroke.push({ x, y });
                            lastPoint = { x, y };
                            lastDrawTime = now;
                        }
                    }
                    isDrawing = true;
                    
                    drawCtx.beginPath();
                    drawCtx.arc(x, y, 10, 0, 2 * Math.PI);
                    drawCtx.fillStyle = '#22c55e';
                    drawCtx.fill();
                    
                    document.getElementById('hand-status').textContent = `âœï¸ Äang váº½ | NÃ©t: ${strokeCount}`;
                    document.getElementById('hand-status').className = 'perf-value';
                    
                } else {
                    // KhÃ´ng váº½ - chá»‰ tracking
                    if (isDrawing && currentStroke.length > 0) {
                        strokeHistory.push([...currentStroke]);
                        lastStrokeEnd = lastPoint;
                    }
                    lastPoint = null;
                    isDrawing = false;
                    currentStroke = [];
                    
                    drawCtx.beginPath();
                    drawCtx.arc(x, y, 6, 0, 2 * Math.PI);
                    drawCtx.fillStyle = inGrid ? 'rgba(249, 158, 11, 0.7)' : 'rgba(255, 100, 100, 0.5)';
                    drawCtx.fill();
                    
                    const msg = inGrid ? 'ğŸ‘† Giá»¯ SPACE Ä‘á»ƒ váº½' : 'âš ï¸ VÃ o Ã´ chá»¯';
                    document.getElementById('hand-status').textContent = msg;
                    document.getElementById('hand-status').className = 'perf-warning';
                }
            } else {
                document.getElementById('hand-status').textContent = 'ğŸ–ï¸ KhÃ´ng tháº¥y tay';
                document.getElementById('hand-status').className = 'perf-danger';
                lastPoint = null;
                isDrawing = false;
                positionHistory = [];
                handStableFrames = 0;
                lastHandPosition = null;
            }
        }

        document.getElementById('btn-camera').addEventListener('click', initCamera);
        
        // SPACE KEY Ä‘á»ƒ váº½
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && camera) {
                e.preventDefault();
                drawingEnabled = true;
                document.getElementById('btn-draw-toggle').classList.add('btn-active');
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                drawingEnabled = false;
                document.getElementById('btn-draw-toggle').classList.remove('btn-active');
                // LÆ°u stroke khi tháº£ phÃ­m
                if (isDrawing && currentStroke.length > 0) {
                    strokeHistory.push([...currentStroke]);
                    lastStrokeEnd = lastPoint;
                }
                lastPoint = null;
                isDrawing = false;
                currentStroke = [];
            }
        });
        
        // NÃšT "Giá»¯ Ä‘á»ƒ váº½" - mouse events
        const btnDrawToggle = document.getElementById('btn-draw-toggle');
        btnDrawToggle.addEventListener('mousedown', () => {
            if (camera) {
                drawingEnabled = true;
                btnDrawToggle.classList.add('btn-active');
            }
        });
        btnDrawToggle.addEventListener('mouseup', () => {
            drawingEnabled = false;
            btnDrawToggle.classList.remove('btn-active');
            if (isDrawing && currentStroke.length > 0) {
                strokeHistory.push([...currentStroke]);
                lastStrokeEnd = lastPoint;
            }
            lastPoint = null;
            isDrawing = false;
            currentStroke = [];
        });
        btnDrawToggle.addEventListener('mouseleave', () => {
            drawingEnabled = false;
            btnDrawToggle.classList.remove('btn-active');
        });
        // Touch events cho mobile
        btnDrawToggle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (camera) {
                drawingEnabled = true;
                btnDrawToggle.classList.add('btn-active');
            }
        });
        btnDrawToggle.addEventListener('touchend', (e) => {
            e.preventDefault();
            drawingEnabled = false;
            btnDrawToggle.classList.remove('btn-active');
            if (isDrawing && currentStroke.length > 0) {
                strokeHistory.push([...currentStroke]);
                lastStrokeEnd = lastPoint;
            }
            lastPoint = null;
            isDrawing = false;
            currentStroke = [];
        });
        
        document.getElementById('btn-undo').addEventListener('click', () => {
            if (strokeHistory.length > 0) {
                strokeHistory.pop();
                strokeCount = Math.max(0, strokeCount - 1);
                // Váº½ láº¡i táº¥t cáº£ stroke cÃ²n láº¡i
                if (persistentCtx) {
                    persistentCtx.clearRect(0, 0, persistentCanvas.width, persistentCanvas.height);
                    strokeHistory.forEach(stroke => {
                        if (stroke.length < 2) return;
                        persistentCtx.beginPath();
                        persistentCtx.moveTo(stroke[0].x, stroke[0].y);
                        for (let i = 1; i < stroke.length; i++) {
                            persistentCtx.lineTo(stroke[i].x, stroke[i].y);
                        }
                        persistentCtx.strokeStyle = '#3b82f6';
                        persistentCtx.lineWidth = 5;
                        persistentCtx.lineCap = 'round';
                        persistentCtx.lineJoin = 'round';
                        persistentCtx.stroke();
                    });
                    // Cáº­p nháº­t lastStrokeEnd
                    if (strokeHistory.length > 0) {
                        const lastStroke = strokeHistory[strokeHistory.length - 1];
                        lastStrokeEnd = lastStroke[lastStroke.length - 1];
                    } else {
                        lastStrokeEnd = null;
                    }
                }
                logResult(`â†©ï¸ Undo nÃ©t ${strokeCount + 1}`);
            }
        });
        
        document.getElementById('btn-clear').addEventListener('click', () => {
            if (persistentCtx) {
                persistentCtx.clearRect(0, 0, persistentCanvas.width, persistentCanvas.height);
            }
            drawCtx.fillStyle = '#111';
            drawCtx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
            lastPoint = null;
            lastStrokeEnd = null;
            strokeCount = 0;
            strokeHistory = [];
            currentStroke = [];
            lastDirection = null;
            positionHistory = [];
            logResult('ğŸ—‘ï¸ ÄÃ£ xÃ³a canvas');
        });
    </script>

    <script>
        // ============ TEST & LOGGING ============
        function logResult(msg) {
            const results = document.getElementById('test-results');
            const time = new Date().toLocaleTimeString();
            results.innerHTML += `<div>[${time}] ${msg}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        async function runFullTest() {
            const btn = document.getElementById('btn-full-test');
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ Äang test...';
            
            logResult('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            logResult('ğŸ§ª Báº®T Äáº¦U FULL TEST (30 giÃ¢y)');
            logResult('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // Device info
            logResult(`ğŸ“± Device: ${navigator.userAgent.substring(0, 50)}...`);
            logResult(`ğŸ–¥ï¸ Screen: ${window.screen.width}x${window.screen.height}`);
            logResult(`ğŸ’¾ Memory: ${navigator.deviceMemory || 'N/A'} GB`);
            logResult(`ğŸ”§ Cores: ${navigator.hardwareConcurrency || 'N/A'}`);
            
            // Test 1: Hanzi Writer Animation
            logResult('');
            logResult('ğŸ“ Test 1: Hanzi Writer Animation...');
            const animStart = performance.now();
            for (let i = 0; i < 5; i++) {
                await new Promise(resolve => {
                    writer.animateCharacter({ onComplete: resolve });
                });
            }
            const animTime = performance.now() - animStart;
            logResult(`   âœ… 5 animations: ${Math.round(animTime)}ms (${Math.round(animTime/5)}ms/each)`);
            
            // Test 2: Character switching
            logResult('');
            logResult('ğŸ“ Test 2: Character Switching...');
            const chars = ['å¥½', 'ä½ ', 'æˆ‘', 'ä»–', 'æ˜¯'];
            const switchStart = performance.now();
            for (const char of chars) {
                initHanziWriter(char);
                await new Promise(r => setTimeout(r, 100));
            }
            const switchTime = performance.now() - switchStart;
            logResult(`   âœ… 5 switches: ${Math.round(switchTime)}ms (${Math.round(switchTime/5)}ms/each)`);
            
            // Test 3: FPS stability
            logResult('');
            logResult('ğŸ“ Test 3: FPS Stability (10s)...');
            await new Promise(r => setTimeout(r, 10000));
            const avgFps = perfData.fps.length > 0 
                ? Math.round(perfData.fps.reduce((a,b) => a+b, 0) / perfData.fps.length) 
                : 0;
            const minFps = perfData.fps.length > 0 ? Math.min(...perfData.fps) : 0;
            logResult(`   âœ… Avg FPS: ${avgFps}, Min FPS: ${minFps}`);
            
            // Test 4: Memory usage
            logResult('');
            logResult('ğŸ“ Test 4: Memory Usage...');
            if (perfData.memory.length > 0) {
                const avgMem = Math.round(perfData.memory.reduce((a,b) => a+b, 0) / perfData.memory.length);
                const maxMem = Math.max(...perfData.memory);
                logResult(`   âœ… Avg Memory: ${avgMem}MB, Max: ${maxMem}MB`);
            } else {
                logResult('   âš ï¸ Memory API khÃ´ng kháº£ dá»¥ng (chá»‰ Chrome)');
            }
            
            // Summary
            logResult('');
            logResult('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            logResult('ğŸ“Š Káº¾T QUáº¢ Tá»”NG Há»¢P');
            logResult('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            let grade = 'A';
            let recommendation = '';
            
            if (avgFps >= 30 && minFps >= 20) {
                grade = 'A';
                recommendation = 'âœ… TUYá»†T Vá»œI! MÃ¡y cháº¡y mÆ°á»£t mÃ .';
            } else if (avgFps >= 20 && minFps >= 10) {
                grade = 'B';
                recommendation = 'ğŸ‘ Tá»T. CÃ³ thá»ƒ dÃ¹ng Ä‘Æ°á»£c, Ä‘Ã´i khi hÆ¡i lag.';
            } else if (avgFps >= 15) {
                grade = 'C';
                recommendation = 'âš ï¸ Táº M ÄÆ¯á»¢C. NÃªn táº¯t Air Writing, chá»‰ dÃ¹ng Quiz.';
            } else {
                grade = 'D';
                recommendation = 'âŒ Yáº¾U. Chá»‰ nÃªn dÃ¹ng Animation cÆ¡ báº£n.';
            }
            
            logResult(`ğŸ† Grade: ${grade}`);
            logResult(recommendation);
            logResult('');
            logResult('ğŸ’¡ YÃŠU Cáº¦U Tá»I THIá»‚U Äá»€ XUáº¤T:');
            logResult('   - CPU: Intel i3 / AMD Ryzen 3 trá»Ÿ lÃªn');
            logResult('   - RAM: 4GB (8GB recommended)');
            logResult('   - Browser: Chrome/Edge má»›i nháº¥t');
            logResult('   - Webcam: 720p (cho Air Writing)');
            logResult('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            btn.disabled = false;
            btn.textContent = 'ğŸ§ª Cháº¡y Full Test (30 giÃ¢y)';
        }

        document.getElementById('btn-full-test').addEventListener('click', runFullTest);

        // ============ INIT ============
        window.onload = () => {
            getDeviceInfo();
            updatePerformance();
            initHanziWriter('å¥½');
            logResult('ğŸš€ PolyBiz AI MVP Ä‘Ã£ sáºµn sÃ ng!');
            logResult('ğŸ’¡ Tip: Nháº¥n "Full Test" Ä‘á»ƒ kiá»ƒm tra hiá»‡u nÄƒng mÃ¡y.');
        };
    </script>
</body>
</html>