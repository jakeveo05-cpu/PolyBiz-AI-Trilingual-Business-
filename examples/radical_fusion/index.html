<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radical Fusion - Gh√©p b·ªô th·ªß b·∫±ng 2 tay</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Mobile responsive */
        @media (max-width: 900px) {
            .game-area {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            .camera-container {
                max-width: 100%;
            }
            
            .fusion-preview {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .fusion-part {
                min-width: 60px;
                padding: 10px 15px;
            }
            
            .fusion-char {
                font-size: 2em;
            }
            
            .radical-list {
                max-height: none !important;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .target-char {
                font-size: 3em;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.3em;
            }
            
            .btn {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .radical-char {
                font-size: 2em;
            }
        }
        
        header {
            text-align: center;
            padding: 10px 0;
        }
        
        h1 {
            font-size: 1.8em;
            background: linear-gradient(90deg, #f5576c, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle { color: #888; font-size: 0.9em; }
        
        .game-area {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .panel-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Camera area */
        .camera-panel {
            position: relative;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        #webcam {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.3;
        }
        
        #game-canvas {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .camera-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .camera-placeholder .icon { font-size: 4em; margin-bottom: 10px; }
        
        /* Radical cards */
        .radical-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }
        
        .radical-card {
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 12px;
            cursor: grab;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .radical-card:hover {
            background: rgba(255,255,255,0.15);
            transform: scale(1.02);
        }
        
        .radical-card.selected {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.2);
        }
        
        .radical-card.left-hand {
            border-color: #f5576c;
            background: rgba(245, 87, 108, 0.2);
        }
        
        .radical-card.right-hand {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.2);
        }
        
        .radical-char {
            font-size: 2.5em;
            font-family: 'Noto Sans SC', serif;
            text-align: center;
        }
        
        .radical-info {
            text-align: center;
            margin-top: 5px;
        }
        
        .radical-pinyin { color: #4facfe; font-size: 0.9em; }
        .radical-meaning { color: #888; font-size: 0.8em; }
        
        /* Target & Result */
        .target-panel {
            display: flex;
            flex-direction: column;
        }
        
        .target-display {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .target-label { color: #888; font-size: 0.9em; margin-bottom: 10px; }
        
        .target-char {
            font-size: 4em;
            font-family: 'Noto Sans SC', serif;
            color: #feca57;
        }
        
        .target-info {
            margin-top: 10px;
        }
        
        .target-pinyin { font-size: 1.3em; color: #4facfe; }
        .target-meaning { color: #aaa; }
        
        .fusion-preview {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .fusion-part {
            text-align: center;
            padding: 15px 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            min-width: 80px;
        }
        
        .fusion-part.left { border: 2px solid #f5576c; }
        .fusion-part.right { border: 2px solid #4facfe; }
        .fusion-part.result { 
            border: 2px solid #feca57;
            background: rgba(254, 202, 87, 0.1);
        }
        
        .fusion-char {
            font-size: 2.5em;
            font-family: 'Noto Sans SC', serif;
        }
        
        .fusion-label {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        
        .fusion-operator {
            font-size: 2em;
            color: #666;
        }
        
        /* Score & Progress */
        .score-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .score-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .score-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ade80;
        }
        
        .score-label { color: #888; font-size: 0.85em; }
        
        .combo-display {
            background: linear-gradient(135deg, #f5576c, #4facfe);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .combo-value {
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .combo-label { font-size: 0.9em; opacity: 0.9; }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            flex: 1;
        }
        
        .btn-primary { background: #3b82f6; color: #fff; }
        .btn-success { background: #22c55e; color: #fff; }
        .btn-warning { background: #f59e0b; color: #000; }
        .btn:hover { transform: scale(1.02); filter: brightness(1.1); }
        
        /* Status */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }
        
        .status-dot.active { background: #22c55e; }
        
        /* Instructions */
        .instructions {
            background: linear-gradient(135deg, rgba(79,172,254,0.1), rgba(245,87,108,0.1));
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .instructions h3 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #4facfe;
        }
        
        .instructions ul {
            list-style: none;
            font-size: 0.85em;
            color: #aaa;
        }
        
        .instructions li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Success animation */
        .success-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .success-overlay.show { display: flex; }
        
        .success-content {
            text-align: center;
            animation: popIn 0.5s ease;
        }
        
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-char {
            font-size: 8em;
            font-family: 'Noto Sans SC', serif;
            color: #feca57;
            text-shadow: 0 0 50px rgba(254, 202, 87, 0.5);
        }
        
        .success-text {
            font-size: 1.5em;
            margin-top: 20px;
            color: #4ade80;
        }
        
        .success-points {
            font-size: 2em;
            color: #4facfe;
            margin-top: 10px;
        }
        
        /* Hand indicators on canvas */
        .hand-indicator {
            position: absolute;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            pointer-events: none;
        }
        
        .hand-left {
            background: rgba(245, 87, 108, 0.8);
            left: 10px;
            top: 10px;
        }
        
        .hand-right {
            background: rgba(79, 172, 254, 0.8);
            right: 10px;
            top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ Radical Fusion - Gh√©p b·ªô th·ªß</h1>
            <p class="subtitle">D√πng 2 tay ƒë·ªÉ gh√©p b·ªô th·ªß th√†nh ch·ªØ H√°n ho√†n ch·ªânh</p>
        </header>
        
        <div class="game-area">
            <!-- Left Panel - Radicals -->
            <div class="panel">
                <div class="panel-title">
                    <span style="color:#f5576c;">üëà</span> B·ªô th·ªß tr√°i
                </div>
                <div id="left-radicals" class="radical-list">
                    <!-- Generated by JS -->
                </div>
            </div>
            
            <!-- Center - Camera & Game -->
            <div class="panel camera-panel">
                <div class="camera-container">
                    <video id="webcam" autoplay playsinline muted></video>
                    <canvas id="game-canvas"></canvas>
                    <div id="camera-placeholder" class="camera-placeholder">
                        <div class="icon">üìπ</div>
                        <div>B·∫≠t camera ƒë·ªÉ ch∆°i</div>
                    </div>
                    <div class="hand-indicator hand-left" id="left-hand-status">ü§ö Tay tr√°i: --</div>
                    <div class="hand-indicator hand-right" id="right-hand-status">ü§ö Tay ph·∫£i: --</div>
                </div>
                
                <div class="status-bar">
                    <div class="status-item">
                        <div class="status-dot" id="camera-dot"></div>
                        <span id="camera-status">Camera OFF</span>
                    </div>
                    <div class="status-item">
                        <span id="hands-detected">Ch∆∞a ph√°t hi·ªán tay</span>
                    </div>
                    <div class="status-item">
                        <span id="fps-display">-- FPS</span>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="btn-camera" class="btn btn-primary">üìπ B·∫≠t Camera</button>
                    <button id="btn-skip" class="btn btn-warning">‚è≠Ô∏è B·ªè qua</button>
                    <button id="btn-hint" class="btn btn-success">üí° G·ª£i √Ω</button>
                </div>
                
                <div class="instructions">
                    <h3>üìñ C√°ch ch∆°i</h3>
                    <ul>
                        <li>üëà Tay tr√°i ch·ªçn b·ªô th·ªß b√™n tr√°i</li>
                        <li>üëâ Tay ph·∫£i ch·ªçn b·ªô th·ªß b√™n ph·∫£i</li>
                        <li>ü§ù Ch·∫°m 2 tay v√†o nhau ƒë·ªÉ gh√©p</li>
                        <li>‚ú® Gh√©p ƒë√∫ng = Ghi ƒëi·ªÉm!</li>
                    </ul>
                </div>
            </div>
            
            <!-- Right Panel - Target & Score -->
            <div class="panel target-panel">
                <div class="target-display">
                    <div class="target-label">üéØ Gh√©p th√†nh ch·ªØ:</div>
                    <div class="target-char" id="target-char">Â•Ω</div>
                    <div class="target-info">
                        <div class="target-pinyin" id="target-pinyin">h«éo</div>
                        <div class="target-meaning" id="target-meaning">T·ªët, Th√≠ch</div>
                    </div>
                </div>
                
                <div class="fusion-preview">
                    <div class="fusion-part left">
                        <div class="fusion-char" id="left-selected">?</div>
                        <div class="fusion-label">Tay tr√°i</div>
                    </div>
                    <div class="fusion-operator">+</div>
                    <div class="fusion-part right">
                        <div class="fusion-char" id="right-selected">?</div>
                        <div class="fusion-label">Tay ph·∫£i</div>
                    </div>
                    <div class="fusion-operator">=</div>
                    <div class="fusion-part result">
                        <div class="fusion-char" id="fusion-result">?</div>
                        <div class="fusion-label">K·∫øt qu·∫£</div>
                    </div>
                </div>
                
                <div class="panel-title" style="margin-top:20px;">
                    <span style="color:#4facfe;">üëâ</span> B·ªô th·ªß ph·∫£i
                </div>
                <div id="right-radicals" class="radical-list">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Overlay -->
    <div class="success-overlay" id="success-overlay">
        <div class="success-content">
            <div class="success-char" id="success-char">Â•Ω</div>
            <div class="success-text">üéâ Ch√≠nh x√°c!</div>
            <div class="success-points" id="success-points">+100 ƒëi·ªÉm</div>
        </div>
    </div>

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</body>
</html>

    <script>
        // ============ GAME DATA ============
        const puzzles = [
            {
                target: 'Â•Ω', pinyin: 'h«éo', meaning: 'T·ªët, Th√≠ch',
                left: { char: 'Â•≥', pinyin: 'n«ö', meaning: 'N·ªØ' },
                right: { char: 'Â≠ê', pinyin: 'z«ê', meaning: 'Con' }
            },
            {
                target: 'Êòé', pinyin: 'm√≠ng', meaning: 'S√°ng, R√µ r√†ng',
                left: { char: 'Êó•', pinyin: 'r√¨', meaning: 'M·∫∑t tr·ªùi' },
                right: { char: 'Êúà', pinyin: 'yu√®', meaning: 'M·∫∑t trƒÉng' }
            },
            {
                target: '‰ºë', pinyin: 'xi≈´', meaning: 'Ngh·ªâ ng∆°i',
                left: { char: '‰∫ª', pinyin: 'r√©n', meaning: 'Ng∆∞·ªùi' },
                right: { char: 'Êú®', pinyin: 'm√π', meaning: 'C√¢y' }
            },
            {
                target: 'Êûó', pinyin: 'l√≠n', meaning: 'R·ª´ng',
                left: { char: 'Êú®', pinyin: 'm√π', meaning: 'C√¢y' },
                right: { char: 'Êú®', pinyin: 'm√π', meaning: 'C√¢y' }
            },
            {
                target: '‰ªé', pinyin: 'c√≥ng', meaning: 'Theo, T·ª´',
                left: { char: '‰∫∫', pinyin: 'r√©n', meaning: 'Ng∆∞·ªùi' },
                right: { char: '‰∫∫', pinyin: 'r√©n', meaning: 'Ng∆∞·ªùi' }
            },
            {
                target: 'Áî∑', pinyin: 'n√°n', meaning: 'Nam',
                left: { char: 'Áî∞', pinyin: 'ti√°n', meaning: 'Ru·ªông' },
                right: { char: 'Âäõ', pinyin: 'l√¨', meaning: 'S·ª©c' }
            },
            {
                target: 'Â¶à', pinyin: 'mƒÅ', meaning: 'M·∫π',
                left: { char: 'Â•≥', pinyin: 'n«ö', meaning: 'N·ªØ' },
                right: { char: 'È©¨', pinyin: 'm«é', meaning: 'Ng·ª±a' }
            },
            {
                target: 'Â•π', pinyin: 'tƒÅ', meaning: 'C√¥ ·∫•y',
                left: { char: 'Â•≥', pinyin: 'n«ö', meaning: 'N·ªØ' },
                right: { char: '‰πü', pinyin: 'yƒõ', meaning: 'C≈©ng' }
            },
            {
                target: '‰ªñ', pinyin: 'tƒÅ', meaning: 'Anh ·∫•y',
                left: { char: '‰∫ª', pinyin: 'r√©n', meaning: 'Ng∆∞·ªùi' },
                right: { char: '‰πü', pinyin: 'yƒõ', meaning: 'C≈©ng' }
            },
            {
                target: 'Âêó', pinyin: 'ma', meaning: 'H·ªèi',
                left: { char: 'Âè£', pinyin: 'k«íu', meaning: 'Mi·ªáng' },
                right: { char: 'È©¨', pinyin: 'm«é', meaning: 'Ng·ª±a' }
            },
            {
                target: '‰Ω†', pinyin: 'n«ê', meaning: 'B·∫°n',
                left: { char: '‰∫ª', pinyin: 'r√©n', meaning: 'Ng∆∞·ªùi' },
                right: { char: 'Â∞î', pinyin: 'ƒõr', meaning: 'Ng∆∞∆°i' }
            },
            {
                target: '‰ª¨', pinyin: 'men', meaning: 'C√°c (s·ªë nhi·ªÅu)',
                left: { char: '‰∫ª', pinyin: 'r√©n', meaning: 'Ng∆∞·ªùi' },
                right: { char: 'Èó®', pinyin: 'm√©n', meaning: 'C·ª≠a' }
            }
        ];
        
        // Extra radicals for distractors
        const extraRadicals = [
            { char: 'Âè£', pinyin: 'k«íu', meaning: 'Mi·ªáng' },
            { char: 'ÂøÉ', pinyin: 'xƒ´n', meaning: 'Tim' },
            { char: 'Êâã', pinyin: 'sh«íu', meaning: 'Tay' },
            { char: 'Ê∞¥', pinyin: 'shu«ê', meaning: 'N∆∞·ªõc' },
            { char: 'ÁÅ´', pinyin: 'hu«í', meaning: 'L·ª≠a' },
            { char: 'Âúü', pinyin: 't«î', meaning: 'ƒê·∫•t' },
            { char: 'Èáë', pinyin: 'jƒ´n', meaning: 'V√†ng' },
            { char: 'Â±±', pinyin: 'shƒÅn', meaning: 'N√∫i' },
            { char: 'Áü≥', pinyin: 'sh√≠', meaning: 'ƒê√°' },
            { char: 'ÁõÆ', pinyin: 'm√π', meaning: 'M·∫Øt' },
            { char: 'ËÄ≥', pinyin: 'ƒõr', meaning: 'Tai' },
            { char: 'Ë∂≥', pinyin: 'z√∫', meaning: 'Ch√¢n' }
        ];
        
        // ============ GAME STATE ============
        let currentPuzzle = null;
        let currentPuzzleIndex = 0;
        let score = 0;
        let combo = 0;
        let leftSelection = null;
        let rightSelection = null;
        
        // Hand tracking state
        let hands = null;
        let camera = null;
        let leftHandPos = null;
        let rightHandPos = null;
        let leftHandGrabbing = false;
        let rightHandGrabbing = false;
        let handsClose = false;
        
        // FPS counter
        let frameCount = 0;
        let lastFpsTime = Date.now();
        let currentFps = 0;
        
        // DOM elements
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('webcam');
        
        // ============ GAME LOGIC ============
        
        function shuffleArray(arr) {
            const shuffled = [...arr];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        function loadPuzzle(index) {
            currentPuzzle = puzzles[index % puzzles.length];
            currentPuzzleIndex = index;
            
            // Update target display
            document.getElementById('target-char').textContent = currentPuzzle.target;
            document.getElementById('target-pinyin').textContent = currentPuzzle.pinyin;
            document.getElementById('target-meaning').textContent = currentPuzzle.meaning;
            
            // Generate radical options (correct + distractors)
            const leftOptions = [currentPuzzle.left];
            const rightOptions = [currentPuzzle.right];
            
            // Add distractors
            const shuffledExtras = shuffleArray(extraRadicals);
            for (let i = 0; i < 3 && i < shuffledExtras.length; i++) {
                if (shuffledExtras[i].char !== currentPuzzle.left.char) {
                    leftOptions.push(shuffledExtras[i]);
                }
                if (shuffledExtras[i + 3] && shuffledExtras[i + 3].char !== currentPuzzle.right.char) {
                    rightOptions.push(shuffledExtras[i + 3]);
                }
            }
            
            // Render radical cards
            renderRadicals('left-radicals', shuffleArray(leftOptions), 'left');
            renderRadicals('right-radicals', shuffleArray(rightOptions), 'right');
            
            // Reset selections
            leftSelection = null;
            rightSelection = null;
            updateFusionPreview();
        }
        
        function renderRadicals(containerId, radicals, side) {
            const container = document.getElementById(containerId);
            container.innerHTML = radicals.map((r, i) => `
                <div class="radical-card" data-char="${r.char}" data-side="${side}" data-index="${i}">
                    <div class="radical-char">${r.char}</div>
                    <div class="radical-info">
                        <div class="radical-pinyin">${r.pinyin}</div>
                        <div class="radical-meaning">${r.meaning}</div>
                    </div>
                </div>
            `).join('');
            
            // Add click handlers (for mouse/touch fallback)
            container.querySelectorAll('.radical-card').forEach(card => {
                card.addEventListener('click', () => {
                    selectRadical(card.dataset.char, side);
                });
            });
        }
        
        function selectRadical(char, side) {
            // Clear previous selection
            document.querySelectorAll(`.radical-card.${side}-hand`).forEach(c => {
                c.classList.remove(`${side}-hand`);
            });
            
            // Select new
            const card = document.querySelector(`.radical-card[data-char="${char}"][data-side="${side}"]`);
            if (card) {
                card.classList.add(`${side}-hand`);
            }
            
            if (side === 'left') {
                leftSelection = char;
            } else {
                rightSelection = char;
            }
            
            updateFusionPreview();
        }
        
        function updateFusionPreview() {
            document.getElementById('left-selected').textContent = leftSelection || '?';
            document.getElementById('right-selected').textContent = rightSelection || '?';
            
            // Check if both selected
            if (leftSelection && rightSelection) {
                // Show combined result (visual only)
                document.getElementById('fusion-result').textContent = 
                    (leftSelection === currentPuzzle.left.char && rightSelection === currentPuzzle.right.char)
                    ? currentPuzzle.target : '‚ùå';
            } else {
                document.getElementById('fusion-result').textContent = '?';
            }
        }
        
        function checkFusion() {
            if (!leftSelection || !rightSelection) return;
            
            if (leftSelection === currentPuzzle.left.char && 
                rightSelection === currentPuzzle.right.char) {
                // Correct!
                combo++;
                const points = 100 * combo;
                score += points;
                
                showSuccess(currentPuzzle.target, points);
                
                // Next puzzle after delay
                setTimeout(() => {
                    loadPuzzle(currentPuzzleIndex + 1);
                }, 2000);
            } else {
                // Wrong
                combo = 0;
                // Visual feedback
                document.getElementById('fusion-result').style.color = '#ef4444';
                setTimeout(() => {
                    document.getElementById('fusion-result').style.color = '';
                }, 500);
            }
        }
        
        function showSuccess(char, points) {
            document.getElementById('success-char').textContent = char;
            document.getElementById('success-points').textContent = `+${points} ƒëi·ªÉm`;
            document.getElementById('success-overlay').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('success-overlay').classList.remove('show');
            }, 1800);
        }
        
        function skipPuzzle() {
            combo = 0;
            loadPuzzle(currentPuzzleIndex + 1);
        }
        
        function showHint() {
            // Highlight correct radicals
            selectRadical(currentPuzzle.left.char, 'left');
            selectRadical(currentPuzzle.right.char, 'right');
        }
        
        // ============ HAND TRACKING ============
        
        async function initCamera() {
            const placeholder = document.getElementById('camera-placeholder');
            const cameraDot = document.getElementById('camera-dot');
            const cameraStatus = document.getElementById('camera-status');
            
            try {
                hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                });
                
                hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.7
                });
                
                hands.onResults(onHandResults);
                
                camera = new Camera(video, {
                    onFrame: async () => {
                        await hands.send({ image: video });
                    },
                    width: 640,
                    height: 480
                });
                
                await camera.start();
                
                canvas.width = 640;
                canvas.height = 480;
                
                placeholder.style.display = 'none';
                cameraDot.classList.add('active');
                cameraStatus.textContent = 'Camera ON';
                
            } catch (err) {
                console.error('Camera error:', err);
                cameraStatus.textContent = 'L·ªói camera';
            }
        }
        
        function isHandGrabbing(landmarks) {
            // Check if fingers are curled (grabbing gesture)
            const tips = [8, 12, 16, 20]; // finger tips
            const pips = [6, 10, 14, 18]; // finger middle joints
            
            let curledCount = 0;
            for (let i = 0; i < tips.length; i++) {
                if (landmarks[tips[i]].y > landmarks[pips[i]].y) {
                    curledCount++;
                }
            }
            return curledCount >= 3;
        }
        
        function getHandCenter(landmarks) {
            // Use palm center (landmark 9)
            return {
                x: landmarks[9].x,
                y: landmarks[9].y
            };
        }
        
        function onHandResults(results) {
            // FPS counter
            frameCount++;
            const now = Date.now();
            if (now - lastFpsTime >= 1000) {
                currentFps = frameCount;
                frameCount = 0;
                lastFpsTime = now;
                document.getElementById('fps-display').textContent = `${currentFps} FPS`;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Reset hand states
            leftHandPos = null;
            rightHandPos = null;
            let handsDetected = 0;
            
            if (results.multiHandLandmarks && results.multiHandedness) {
                for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                    const landmarks = results.multiHandLandmarks[i];
                    const handedness = results.multiHandedness[i].label;
                    
                    // Mirror: MediaPipe "Left" is actually right hand on screen
                    const isLeftHand = handedness === 'Right';
                    const center = getHandCenter(landmarks);
                    const grabbing = isHandGrabbing(landmarks);
                    
                    // Convert to canvas coords (mirrored)
                    const x = (1 - center.x) * canvas.width;
                    const y = center.y * canvas.height;
                    
                    if (isLeftHand) {
                        leftHandPos = { x, y };
                        leftHandGrabbing = grabbing;
                        drawHand(x, y, '#f5576c', grabbing, 'üëà');
                        document.getElementById('left-hand-status').textContent = 
                            `ü§ö Tr√°i: ${grabbing ? '‚úä N·∫Øm' : '‚úã M·ªü'}`;
                    } else {
                        rightHandPos = { x, y };
                        rightHandGrabbing = grabbing;
                        drawHand(x, y, '#4facfe', grabbing, 'üëâ');
                        document.getElementById('right-hand-status').textContent = 
                            `ü§ö Ph·∫£i: ${grabbing ? '‚úä N·∫Øm' : '‚úã M·ªü'}`;
                    }
                    
                    handsDetected++;
                }
            }
            
            // Update hands detected status
            document.getElementById('hands-detected').textContent = 
                handsDetected === 0 ? 'Ch∆∞a ph√°t hi·ªán tay' :
                handsDetected === 1 ? '1 tay' : '2 tay ‚úì';
            
            // Check if hands are close together (fusion gesture)
            if (leftHandPos && rightHandPos) {
                const dist = Math.sqrt(
                    Math.pow(leftHandPos.x - rightHandPos.x, 2) +
                    Math.pow(leftHandPos.y - rightHandPos.y, 2)
                );
                
                // Draw connection line
                ctx.beginPath();
                ctx.moveTo(leftHandPos.x, leftHandPos.y);
                ctx.lineTo(rightHandPos.x, rightHandPos.y);
                ctx.strokeStyle = dist < 100 ? '#feca57' : 'rgba(255,255,255,0.2)';
                ctx.lineWidth = dist < 100 ? 4 : 2;
                ctx.stroke();
                
                // Fusion zone indicator
                if (dist < 100) {
                    const midX = (leftHandPos.x + rightHandPos.x) / 2;
                    const midY = (leftHandPos.y + rightHandPos.y) / 2;
                    
                    ctx.beginPath();
                    ctx.arc(midX, midY, 50, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(254, 202, 87, 0.3)';
                    ctx.fill();
                    ctx.strokeStyle = '#feca57';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // Draw fusion text
                    ctx.font = 'bold 20px sans-serif';
                    ctx.fillStyle = '#feca57';
                    ctx.textAlign = 'center';
                    ctx.fillText('ü§ù FUSION!', midX, midY - 60);
                    
                    if (!handsClose) {
                        handsClose = true;
                        checkFusion();
                    }
                } else {
                    handsClose = false;
                }
            }
            
            // Detect which radical each hand is hovering
            detectRadicalHover();
        }
        
        function drawHand(x, y, color, grabbing, emoji) {
            // Outer glow
            ctx.beginPath();
            ctx.arc(x, y, grabbing ? 35 : 45, 0, Math.PI * 2);
            ctx.fillStyle = color + '33';
            ctx.fill();
            
            // Inner circle
            ctx.beginPath();
            ctx.arc(x, y, grabbing ? 25 : 35, 0, Math.PI * 2);
            ctx.fillStyle = color + '88';
            ctx.fill();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Emoji
            ctx.font = '24px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#fff';
            ctx.fillText(grabbing ? '‚úä' : '‚úã', x, y);
        }
        
        function detectRadicalHover() {
            // This is simplified - in real implementation, 
            // we'd map hand positions to radical card positions
            // For now, use vertical position to select
            
            if (leftHandPos && leftHandGrabbing) {
                const cards = document.querySelectorAll('#left-radicals .radical-card');
                const index = Math.floor((leftHandPos.y / canvas.height) * cards.length);
                if (index >= 0 && index < cards.length) {
                    selectRadical(cards[index].dataset.char, 'left');
                }
            }
            
            if (rightHandPos && rightHandGrabbing) {
                const cards = document.querySelectorAll('#right-radicals .radical-card');
                const index = Math.floor((rightHandPos.y / canvas.height) * cards.length);
                if (index >= 0 && index < cards.length) {
                    selectRadical(cards[index].dataset.char, 'right');
                }
            }
        }
        
        // ============ EVENT LISTENERS ============
        
        document.getElementById('btn-camera').addEventListener('click', initCamera);
        document.getElementById('btn-skip').addEventListener('click', skipPuzzle);
        document.getElementById('btn-hint').addEventListener('click', showHint);
        
        // ============ INIT ============
        
        loadPuzzle(0);
    </script>
