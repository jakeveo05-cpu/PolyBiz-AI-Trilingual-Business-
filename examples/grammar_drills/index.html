<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyBiz AI - Grammar Drills ËØ≠Ê≥ïÁªÉ‰π†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; color: #fff; padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }
        
        .card {
            background: rgba(255,255,255,0.05); border-radius: 15px;
            padding: 25px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Stats */
        .stats-bar {
            display: flex; justify-content: space-around; padding: 15px;
            background: rgba(0,0,0,0.3); border-radius: 10px; margin-bottom: 20px;
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #60a5fa; }
        .stat-label { font-size: 0.8em; color: #888; }
        
        /* Grammar Topics */
        .topics-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .topic-card {
            padding: 20px; background: rgba(255,255,255,0.05);
            border: 2px solid transparent; border-radius: 12px;
            cursor: pointer; transition: all 0.3s;
        }
        .topic-card:hover { border-color: #60a5fa; transform: translateY(-2px); }
        .topic-card.selected { border-color: #3b82f6; background: rgba(59,130,246,0.2); }
        .topic-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .topic-icon { font-size: 1.8em; }
        .topic-name { font-weight: bold; font-size: 1.1em; }
        .topic-desc { color: #888; font-size: 0.85em; margin-bottom: 10px; }
        .topic-progress {
            height: 6px; background: rgba(255,255,255,0.1);
            border-radius: 3px; overflow: hidden;
        }
        .topic-progress-fill { height: 100%; background: #22c55e; transition: width 0.3s; }
        .topic-stats { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8em; color: #888; }
        
        /* Exercise Types */
        .exercise-tabs {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .exercise-tab {
            padding: 10px 20px; border: none; border-radius: 20px;
            background: rgba(255,255,255,0.05); color: #888;
            cursor: pointer; transition: all 0.2s; font-size: 0.9em;
        }
        .exercise-tab:hover { background: rgba(255,255,255,0.1); }
        .exercise-tab.active { background: rgba(59,130,246,0.3); color: #fff; }
        
        /* Question Area */
        .question-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .question-number { color: #888; }
        .question-type {
            padding: 5px 12px; border-radius: 15px;
            background: rgba(139,92,246,0.2); color: #a78bfa; font-size: 0.85em;
        }
        
        .question-content {
            background: rgba(0,0,0,0.2); border-radius: 15px;
            padding: 25px; margin-bottom: 20px;
        }
        .grammar-point {
            display: inline-block; padding: 8px 15px; margin-bottom: 15px;
            background: rgba(251,191,36,0.2); border-radius: 10px;
            color: #fbbf24; font-size: 0.9em;
        }
        .question-text {
            font-size: 1.4em; margin-bottom: 15px; line-height: 1.6;
            font-family: 'Noto Sans SC', serif;
        }
        .question-text .blank {
            display: inline-block; min-width: 80px; border-bottom: 2px dashed #60a5fa;
            text-align: center; color: #60a5fa; padding: 0 10px;
        }
        .question-hint { color: #888; font-size: 0.95em; }
        
        /* Options */
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option {
            padding: 15px 20px; border: 2px solid #333; border-radius: 12px;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 15px;
        }
        .option:hover { border-color: #60a5fa; background: rgba(96,165,250,0.1); }
        .option.selected { border-color: #3b82f6; background: rgba(59,130,246,0.2); }
        .option.correct { border-color: #22c55e; background: rgba(34,197,94,0.2); }
        .option.wrong { border-color: #ef4444; background: rgba(239,68,68,0.2); }
        .option.disabled { pointer-events: none; opacity: 0.7; }
        .option-letter {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.1); display: flex;
            align-items: center; justify-content: center; font-weight: bold;
        }
        .option-text { flex: 1; font-size: 1.1em; }
        .option-icon { font-size: 1.2em; }
        
        /* Fill in blank input */
        .fill-input {
            width: 100%; padding: 15px 20px; font-size: 1.2em;
            background: rgba(0,0,0,0.3); border: 2px solid #333;
            border-radius: 12px; color: #fff; margin-bottom: 15px;
        }
        .fill-input:focus { outline: none; border-color: #3b82f6; }
        .fill-input.correct { border-color: #22c55e; }
        .fill-input.wrong { border-color: #ef4444; }
        
        /* Reorder */
        .reorder-container {
            display: flex; flex-wrap: wrap; gap: 10px; min-height: 60px;
            padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px;
            margin-bottom: 15px; border: 2px dashed #333;
        }
        .reorder-container.target { border-color: #3b82f6; }
        .word-chip {
            padding: 10px 18px; background: rgba(59,130,246,0.3);
            border-radius: 10px; cursor: grab; font-size: 1.1em;
            transition: all 0.2s; user-select: none;
        }
        .word-chip:hover { background: rgba(59,130,246,0.5); transform: scale(1.05); }
        .word-chip.dragging { opacity: 0.5; }
        .word-chip.placed { background: rgba(34,197,94,0.3); }
        
        /* Explanation */
        .explanation {
            padding: 20px; background: rgba(34,197,94,0.1);
            border-radius: 12px; border-left: 4px solid #22c55e;
            margin-top: 20px; display: none;
        }
        .explanation.show { display: block; }
        .explanation h4 { color: #22c55e; margin-bottom: 10px; }
        .explanation p { color: #aaa; line-height: 1.6; }
        .explanation .example {
            margin-top: 10px; padding: 10px 15px;
            background: rgba(0,0,0,0.2); border-radius: 8px;
        }
        .explanation .example-zh { font-size: 1.1em; margin-bottom: 5px; }
        .explanation .example-vi { color: #888; font-size: 0.9em; }
        
        /* Buttons */
        .btn-row { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .btn {
            padding: 12px 30px; border: none; border-radius: 10px;
            cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.2s;
        }
        .btn-primary { background: #3b82f6; color: #fff; }
        .btn-success { background: #22c55e; color: #fff; }
        .btn-secondary { background: #6b7280; color: #fff; }
        .btn:hover { transform: scale(1.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Progress */
        .progress-bar {
            height: 8px; background: rgba(255,255,255,0.1);
            border-radius: 4px; margin-bottom: 20px; overflow: hidden;
        }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #22c55e); transition: width 0.3s; }
        
        /* Results */
        .results { text-align: center; padding: 40px; }
        .results-icon { font-size: 5em; margin-bottom: 20px; }
        .results-score { font-size: 3em; font-weight: bold; color: #60a5fa; }
        .results-label { color: #888; margin-bottom: 30px; }
        .results-breakdown { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
        .breakdown-item { text-align: center; }
        .breakdown-value { font-size: 2em; font-weight: bold; }
        .breakdown-label { color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Grammar Drills ËØ≠Ê≥ïÁªÉ‰π†</h1>
        <p class="subtitle">Luy·ªán ng·ªØ ph√°p ti·∫øng Trung qua b√†i t·∫≠p</p>
        
        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="stat-completed">0</div>
                <div class="stat-label">ƒê√£ ho√†n th√†nh</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-accuracy">0%</div>
                <div class="stat-label">ƒê·ªô ch√≠nh x√°c</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-streak">0</div>
                <div class="stat-label">Streak üî•</div>
            </div>
        </div>
        
        <!-- Topic Selection -->
        <div id="topic-screen">
            <div class="card">
                <h3 style="margin-bottom:15px;">üìö Ch·ªçn ch·ªß ƒë·ªÅ ng·ªØ ph√°p</h3>
                <div class="topics-grid" id="topics-grid"></div>
            </div>
        </div>
        
        <!-- Exercise Screen -->
        <div id="exercise-screen" style="display:none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width:0%"></div>
            </div>
            
            <div class="exercise-tabs" id="exercise-tabs"></div>
            
            <div class="card">
                <div class="question-header">
                    <span class="question-number" id="question-number">C√¢u 1/10</span>
                    <span class="question-type" id="question-type">Ch·ªçn ƒë√°p √°n</span>
                </div>
                
                <div class="question-content">
                    <div class="grammar-point" id="grammar-point">ÊòØ...ÁöÑ (sh√¨...de)</div>
                    <div class="question-text" id="question-text"></div>
                    <div class="question-hint" id="question-hint"></div>
                </div>
                
                <div id="answer-area"></div>
                
                <div class="explanation" id="explanation">
                    <h4>üí° Gi·∫£i th√≠ch</h4>
                    <p id="explanation-text"></p>
                    <div class="example" id="explanation-example"></div>
                </div>
                
                <div class="btn-row">
                    <button class="btn btn-secondary" id="btn-skip" onclick="skipQuestion()">B·ªè qua</button>
                    <button class="btn btn-primary" id="btn-check" onclick="checkAnswer()">Ki·ªÉm tra</button>
                    <button class="btn btn-success" id="btn-next" onclick="nextQuestion()" style="display:none;">Ti·∫øp theo ‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div id="results-screen" style="display:none;">
            <div class="card results">
                <div class="results-icon" id="results-icon">üéâ</div>
                <div class="results-score" id="results-score">8/10</div>
                <div class="results-label">ƒêi·ªÉm s·ªë</div>
                
                <div class="results-breakdown">
                    <div class="breakdown-item">
                        <div class="breakdown-value" style="color:#22c55e;" id="correct-count">8</div>
                        <div class="breakdown-label">ƒê√∫ng</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-value" style="color:#ef4444;" id="wrong-count">2</div>
                        <div class="breakdown-label">Sai</div>
                    </div>
                </div>
                
                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="backToTopics()">‚Üê Ch·ªçn ch·ªß ƒë·ªÅ</button>
                    <button class="btn btn-success" onclick="restartTopic()">üîÑ L√†m l·∫°i</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ GRAMMAR DATA ============
        const GRAMMAR_TOPICS = {
            shi_de: {
                name: 'ÊòØ...ÁöÑ', icon: 'üéØ',
                desc: 'Nh·∫•n m·∫°nh th·ªùi gian, ƒë·ªãa ƒëi·ªÉm, c√°ch th·ª©c',
                exercises: [
                    { type: 'choice', grammar: 'ÊòØ...ÁöÑ', text: 'Êàë___Êò®Â§©Êù•ÁöÑ„ÄÇ', hint: 'Nh·∫•n m·∫°nh th·ªùi gian ƒë·∫øn', options: ['ÊòØ', 'Âú®', 'Êúâ', '‰ºö'], answer: 0, explain: 'ÊòØ...ÁöÑ d√πng ƒë·ªÉ nh·∫•n m·∫°nh th·ªùi gian, ƒë·ªãa ƒëi·ªÉm ho·∫∑c c√°ch th·ª©c c·ªßa h√†nh ƒë·ªông ƒë√£ x·∫£y ra.', example: 'ÊàëÊòØÂùêÈ£ûÊú∫Êù•ÁöÑ„ÄÇ', exampleVi: 'T√¥i ƒë·∫øn b·∫±ng m√°y bay.' },
                    { type: 'choice', grammar: 'ÊòØ...ÁöÑ', text: '‰ªñÊòØÂú®Âåó‰∫¨___ÁöÑ‰∏≠Êñá„ÄÇ', hint: 'Nh·∫•n m·∫°nh ƒë·ªãa ƒëi·ªÉm h·ªçc', options: ['Â≠¶', 'Â≠¶‰π†', 'Áúã', 'ËØ¥'], answer: 0, explain: 'ÊòØ...ÁöÑ v·ªõi ƒë·ªãa ƒëi·ªÉm: ÊòØ + Âú® + ƒë·ªãa ƒëi·ªÉm + Âä®ËØç + ÁöÑ', example: 'Â•πÊòØÂú®‰∏äÊµ∑Âá∫ÁîüÁöÑ„ÄÇ', exampleVi: 'C√¥ ·∫•y sinh ra ·ªü Th∆∞·ª£ng H·∫£i.' },
                    { type: 'fill', grammar: 'ÊòØ...ÁöÑ', text: '‰Ω†ÊòØ‰ªÄ‰πàÊó∂ÂÄôÊù•‰∏≠ÂõΩ___Ôºü', hint: 'ƒêi·ªÅn t·ª´ c√≤n thi·∫øu', answer: 'ÁöÑ', explain: 'C√¢u h·ªèi v·ªõi ÊòØ...ÁöÑ: ÊòØ + ÁñëÈóÆËØç + Âä®ËØç + ÁöÑ', example: '‰Ω†ÊòØÊÄé‰πàÊù•ÁöÑÔºü', exampleVi: 'B·∫°n ƒë·∫øn b·∫±ng c√°ch n√†o?' },
                    { type: 'reorder', grammar: 'ÊòØ...ÁöÑ', words: ['Êàë', 'ÊòØ', 'Âùê', 'ÁÅ´ËΩ¶', 'Êù•', 'ÁöÑ'], answer: 'ÊàëÊòØÂùêÁÅ´ËΩ¶Êù•ÁöÑ', hint: 'S·∫Øp x·∫øp c√¢u nh·∫•n m·∫°nh ph∆∞∆°ng ti·ªán', explain: 'C·∫•u tr√∫c: ‰∏ªËØ≠ + ÊòØ + ÊñπÂºè + Âä®ËØç + ÁöÑ', example: '‰ªñÊòØÈ™ëËá™Ë°åËΩ¶ÂéªÁöÑ„ÄÇ', exampleVi: 'Anh ·∫•y ƒëi b·∫±ng xe ƒë·∫°p.' },
                    { type: 'choice', grammar: 'ÊòØ...ÁöÑ', text: 'ËøôÊú¨‰π¶ÊòØË∞Å‰π∞___Ôºü', hint: 'Ho√†n th√†nh c√¢u h·ªèi', options: ['ÁöÑ', '‰∫Ü', 'Ëøá', 'ÁùÄ'], answer: 0, explain: 'ÊòØ...ÁöÑ d√πng trong c√¢u h·ªèi ƒë·ªÉ h·ªèi v·ªÅ chi ti·∫øt c·ªßa h√†nh ƒë·ªông ƒë√£ x·∫£y ra.', example: 'Ëøô‰ª∂Ë°£ÊúçÊòØÂú®Âì™ÂÑø‰π∞ÁöÑÔºü', exampleVi: 'C√°i √°o n√†y mua ·ªü ƒë√¢u?' },
                ]
            },
            le: {
                name: '‰∫Ü (le)', icon: '‚úÖ',
                desc: 'Ho√†n th√†nh, thay ƒë·ªïi tr·∫°ng th√°i',
                exercises: [
                    { type: 'choice', grammar: '‰∫Ü', text: 'ÊàëÂêÉ___Êó©È•≠‰∫Ü„ÄÇ', hint: 'H√†nh ƒë·ªông ƒë√£ ho√†n th√†nh', options: ['‰∫Ü', 'Ëøá', 'ÁùÄ', 'ÁöÑ'], answer: 0, explain: '‰∫Ü sau ƒë·ªông t·ª´ bi·ªÉu th·ªã h√†nh ƒë·ªông ƒë√£ ho√†n th√†nh.', example: '‰ªñ‰π∞‰∫Ü‰∏ÄÊú¨‰π¶„ÄÇ', exampleVi: 'Anh ·∫•y ƒë√£ mua m·ªôt quy·ªÉn s√°ch.' },
                    { type: 'choice', grammar: '‰∫Ü', text: 'Â§©Ê∞îÂÜ∑___ÔºåË¶ÅÂ§öÁ©øË°£Êúç„ÄÇ', hint: 'Thay ƒë·ªïi tr·∫°ng th√°i', options: ['‰∫Ü', 'Ëøá', 'ÁùÄ', 'ÁöÑ'], answer: 0, explain: '‰∫Ü cu·ªëi c√¢u bi·ªÉu th·ªã s·ª± thay ƒë·ªïi tr·∫°ng th√°i ho·∫∑c t√¨nh hu·ªëng m·ªõi.', example: '‰∏ãÈõ®‰∫ÜÔºÅ', exampleVi: 'Tr·ªùi m∆∞a r·ªìi!' },
                    { type: 'fill', grammar: '‰∫Ü', text: 'ÊàëÂ∑≤ÁªèÂÅöÂÆå‰Ωú‰∏ö___„ÄÇ', hint: 'ƒêi·ªÅn tr·ª£ t·ª´', answer: '‰∫Ü', explain: '‰∫Ü k·∫øt h·ª£p v·ªõi Â∑≤Áªè nh·∫•n m·∫°nh h√†nh ƒë·ªông ƒë√£ ho√†n th√†nh.', example: 'ÊàëÂ∑≤ÁªèÂêÉ‰∫Ü„ÄÇ', exampleVi: 'T√¥i ƒë√£ ƒÉn r·ªìi.' },
                    { type: 'reorder', grammar: '‰∫Ü', words: ['‰ªñ', 'Âéª', '‰∫Ü', '‰∏≠ÂõΩ', '‰∏âÊ¨°'], answer: '‰ªñÂéª‰∫Ü‰∏≠ÂõΩ‰∏âÊ¨°', hint: 'S·∫Øp x·∫øp c√¢u v·ªõi ‰∫Ü', explain: 'Âä®ËØç + ‰∫Ü + ÂÆæËØ≠ + Êï∞Èáè', example: 'ÊàëÁúã‰∫Ü‰∏§ÈÉ®ÁîµÂΩ±„ÄÇ', exampleVi: 'T√¥i ƒë√£ xem hai b·ªô phim.' },
                    { type: 'choice', grammar: '‰∫Ü', text: 'Êàë‰∏çÊÉ≥ÂêÉ___ÔºåÊàëÂêÉÈ•±‰∫Ü„ÄÇ', hint: 'Ph·ªß ƒë·ªãnh v·ªõi ‰∫Ü', options: ['‰∫Ü', 'Ëøá', 'ÁùÄ', 'ÁöÑ'], answer: 0, explain: '‰∫Ü cu·ªëi c√¢u bi·ªÉu th·ªã tr·∫°ng th√°i hi·ªán t·∫°i (ƒë√£ no).', example: 'ÊàëÁ¥Ø‰∫ÜÔºåÊÉ≥‰ºëÊÅØ„ÄÇ', exampleVi: 'T√¥i m·ªát r·ªìi, mu·ªën ngh·ªâ ng∆°i.' },
                ]
            },
            guo: {
                name: 'Ëøá (gu√≤)', icon: 'üîÑ',
                desc: 'Kinh nghi·ªám, ƒë√£ t·ª´ng',
                exercises: [
                    { type: 'choice', grammar: 'Ëøá', text: 'ÊàëÂéª___‰∏≠ÂõΩ„ÄÇ', hint: 'ƒê√£ t·ª´ng ƒëi', options: ['Ëøá', '‰∫Ü', 'ÁùÄ', 'ÁöÑ'], answer: 0, explain: 'Ëøá bi·ªÉu th·ªã kinh nghi·ªám - ƒë√£ t·ª´ng l√†m g√¨ ƒë√≥.', example: 'ÊàëÂêÉËøáÂåó‰∫¨ÁÉ§È∏≠„ÄÇ', exampleVi: 'T√¥i ƒë√£ t·ª´ng ƒÉn v·ªãt quay B·∫Øc Kinh.' },
                    { type: 'choice', grammar: 'Ëøá', text: '‰Ω†Áúã___ËøôÈÉ®ÁîµÂΩ±ÂêóÔºü', hint: 'H·ªèi v·ªÅ kinh nghi·ªám', options: ['Ëøá', '‰∫Ü', 'ÁùÄ', 'ÁöÑ'], answer: 0, explain: 'Âä®ËØç + Ëøá + ÂêóÔºü ƒë·ªÉ h·ªèi v·ªÅ kinh nghi·ªám.', example: '‰Ω†Â≠¶ËøáÊó•ËØ≠ÂêóÔºü', exampleVi: 'B·∫°n ƒë√£ t·ª´ng h·ªçc ti·∫øng Nh·∫≠t ch∆∞a?' },
                    { type: 'fill', grammar: 'Ëøá', text: 'ÊàëÊ≤°ÂêÉ___Êó•Êú¨Ëèú„ÄÇ', hint: 'Ph·ªß ƒë·ªãnh kinh nghi·ªám', answer: 'Ëøá', explain: 'Ê≤° + Âä®ËØç + Ëøá = ch∆∞a t·ª´ng', example: 'ÊàëÊ≤°ÂéªËøáÁæéÂõΩ„ÄÇ', exampleVi: 'T√¥i ch∆∞a t·ª´ng ƒëi M·ªπ.' },
                    { type: 'reorder', grammar: 'Ëøá', words: ['Â•π', '‰ª•Ââç', 'Â≠¶', 'Ëøá', '‰∏≠Êñá'], answer: 'Â•π‰ª•ÂâçÂ≠¶Ëøá‰∏≠Êñá', hint: 'S·∫Øp x·∫øp c√¢u kinh nghi·ªám', explain: '‰ª•Ââç + Âä®ËØç + Ëøá nh·∫•n m·∫°nh kinh nghi·ªám trong qu√° kh·ª©.', example: 'Êàë‰ª•Ââç‰ΩèËøá‰∏äÊµ∑„ÄÇ', exampleVi: 'T√¥i tr∆∞·ªõc ƒë√¢y ƒë√£ t·ª´ng s·ªëng ·ªü Th∆∞·ª£ng H·∫£i.' },
                    { type: 'choice', grammar: 'Ëøá', text: 'ËøôÁßç‰∫ãÊàë‰ªéÊù•Ê≤°ËßÅ___„ÄÇ', hint: 'Ch∆∞a bao gi·ªù th·∫•y', options: ['Ëøá', '‰∫Ü', 'ÁùÄ', 'ÁöÑ'], answer: 0, explain: '‰ªéÊù•Ê≤° + Âä®ËØç + Ëøá = ch∆∞a bao gi·ªù', example: 'Êàë‰ªéÊù•Ê≤°ËøüÂà∞Ëøá„ÄÇ', exampleVi: 'T√¥i ch∆∞a bao gi·ªù ƒë·∫øn mu·ªôn.' },
                ]
            },
            zhe: {
                name: 'ÁùÄ (zhe)', icon: '‚è≥',
                desc: 'Tr·∫°ng th√°i ƒëang di·ªÖn ra',
                exercises: [
                    { type: 'choice', grammar: 'ÁùÄ', text: 'Èó®ÂºÄ___Âë¢„ÄÇ', hint: 'Tr·∫°ng th√°i c·ª≠a', options: ['ÁùÄ', '‰∫Ü', 'Ëøá', 'ÁöÑ'], answer: 0, explain: 'ÁùÄ bi·ªÉu th·ªã tr·∫°ng th√°i ƒëang duy tr√¨.', example: 'ÁÅØ‰∫ÆÁùÄ„ÄÇ', exampleVi: 'ƒê√®n ƒëang s√°ng.' },
                    { type: 'choice', grammar: 'ÁùÄ', text: '‰ªñÁ´ô___ËØ¥ËØù„ÄÇ', hint: 'V·ª´a ƒë·ª©ng v·ª´a n√≥i', options: ['ÁùÄ', '‰∫Ü', 'Ëøá', 'ÁöÑ'], answer: 0, explain: 'Âä®ËØç1 + ÁùÄ + Âä®ËØç2 = v·ª´a l√†m A v·ª´a l√†m B', example: 'Â•πÁ¨ëÁùÄËØ¥„ÄÇ', exampleVi: 'C√¥ ·∫•y v·ª´a c∆∞·ªùi v·ª´a n√≥i.' },
                    { type: 'fill', grammar: 'ÁùÄ', text: 'Â¢ô‰∏äÊåÇ___‰∏ÄÂπÖÁîª„ÄÇ', hint: 'Tr·∫°ng th√°i treo', answer: 'ÁùÄ', explain: 'ÁùÄ m√¥ t·∫£ tr·∫°ng th√°i c·ªßa v·∫≠t.', example: 'Ê°åÂ≠ê‰∏äÊîæÁùÄ‰∏ÄÊú¨‰π¶„ÄÇ', exampleVi: 'Tr√™n b√†n ƒë·∫∑t m·ªôt quy·ªÉn s√°ch.' },
                    { type: 'reorder', grammar: 'ÁùÄ', words: ['‰ªñ', 'Á©ø', 'ÁùÄ', '‰∏Ä‰ª∂', 'Á∫¢Ëâ≤', 'ÁöÑ', 'Ë°£Êúç'], answer: '‰ªñÁ©øÁùÄ‰∏Ä‰ª∂Á∫¢Ëâ≤ÁöÑË°£Êúç', hint: 'M√¥ t·∫£ trang ph·ª•c', explain: 'Á©øÁùÄ m√¥ t·∫£ tr·∫°ng th√°i ƒëang m·∫∑c.', example: 'Â•πÊà¥ÁùÄÁúºÈïú„ÄÇ', exampleVi: 'C√¥ ·∫•y ƒëang ƒëeo k√≠nh.' },
                    { type: 'choice', grammar: 'ÁùÄ', text: 'Âà´Á´ô___ÔºåËØ∑Âùê„ÄÇ', hint: 'ƒê·ª´ng ƒë·ª©ng', options: ['ÁùÄ', '‰∫Ü', 'Ëøá', 'ÁöÑ'], answer: 0, explain: 'Âà´ + Âä®ËØç + ÁùÄ = ƒë·ª´ng duy tr√¨ tr·∫°ng th√°i ƒë√≥', example: 'Âà´ÂºÄÁùÄÁ™óÊà∑Áù°Ëßâ„ÄÇ', exampleVi: 'ƒê·ª´ng m·ªü c·ª≠a s·ªï m√† ng·ªß.' },
                ]
            },
            bi: {
                name: 'ÊØî (b«ê)', icon: '‚öñÔ∏è',
                desc: 'So s√°nh h∆°n',
                exercises: [
                    { type: 'choice', grammar: 'ÊØî', text: '‰ªñ___ÊàëÈ´ò„ÄÇ', hint: 'So s√°nh chi·ªÅu cao', options: ['ÊØî', 'Âíå', 'Ë∑ü', 'ÂØπ'], answer: 0, explain: 'A + ÊØî + B + ÂΩ¢ÂÆπËØç = A h∆°n B', example: '‰ªäÂ§©ÊØîÊò®Â§©ÂÜ∑„ÄÇ', exampleVi: 'H√¥m nay l·∫°nh h∆°n h√¥m qua.' },
                    { type: 'choice', grammar: 'ÊØî', text: 'ËãπÊûúÊØîÈ¶ôËïâ___„ÄÇ', hint: 'So s√°nh gi√°', options: ['Ë¥µ', 'Ë¥µ‰∫Ü', 'ÂæàË¥µ', 'ÊúÄË¥µ'], answer: 0, explain: 'Sau ÊØî kh√¥ng d√πng Âæà, ch·ªâ d√πng t√≠nh t·ª´ ƒë∆°n.', example: 'Ëøô‰∏™ÊØîÈÇ£‰∏™Â•Ω„ÄÇ', exampleVi: 'C√°i n√†y t·ªët h∆°n c√°i kia.' },
                    { type: 'fill', grammar: 'ÊØî', text: '‰ªñÊØîÊàëÂ§ß‰∏â___„ÄÇ', hint: 'ƒê∆°n v·ªã tu·ªïi', answer: 'Â≤Å', explain: 'A ÊØî B + ÂΩ¢ÂÆπËØç + Êï∞Èáè = A h∆°n B bao nhi√™u', example: 'ËøôÊù°Ë∑ØÊØîÈÇ£Êù°Èïø‰∏§ÂÖ¨Èáå„ÄÇ', exampleVi: 'Con ƒë∆∞·ªùng n√†y d√†i h∆°n con ƒë∆∞·ªùng kia 2km.' },
                    { type: 'reorder', grammar: 'ÊØî', words: ['‰∏≠Êñá', 'ÊØî', 'Ëã±Êñá', 'Èöæ', 'Â§ö‰∫Ü'], answer: '‰∏≠ÊñáÊØîËã±ÊñáÈöæÂ§ö‰∫Ü', hint: 'So s√°nh ƒë·ªô kh√≥', explain: 'ÊØî + ÂΩ¢ÂÆπËØç + Â§ö‰∫Ü = h∆°n nhi·ªÅu', example: '‰ªñÊØîÊàëÂøôÂ§ö‰∫Ü„ÄÇ', exampleVi: 'Anh ·∫•y b·∫≠n h∆°n t√¥i nhi·ªÅu.' },
                    { type: 'choice', grammar: 'ÊØî', text: '‰ªñË∑ëÂæóÊØîÊàë___„ÄÇ', hint: 'So s√°nh t·ªëc ƒë·ªô', options: ['Âø´', 'ÂæàÂø´', 'Âø´‰∫Ü', 'ÊúÄÂø´'], answer: 0, explain: 'Âä®ËØç + Âæó + ÊØî + ÂØπË±° + ÂΩ¢ÂÆπËØç', example: 'Â•πËØ¥‰∏≠ÊñáËØ¥ÂæóÊØîÊàëÂ•Ω„ÄÇ', exampleVi: 'C√¥ ·∫•y n√≥i ti·∫øng Trung t·ªët h∆°n t√¥i.' },
                ]
            },
            ba: {
                name: 'Êää (b«é)', icon: 'üéØ',
                desc: 'C√¢u ch·ªØ Êää - x·ª≠ l√Ω ƒë·ªëi t∆∞·ª£ng',
                exercises: [
                    { type: 'choice', grammar: 'Êää', text: 'ËØ∑___Èó®ÂÖ≥‰∏ä„ÄÇ', hint: 'ƒê√≥ng c·ª≠a l·∫°i', options: ['Êää', 'Ë¢´', 'ËÆ©', 'Áªô'], answer: 0, explain: 'Êää + ÂÆæËØ≠ + Âä®ËØç + Ë°•ËØ≠ = l√†m g√¨ v·ªõi ƒë·ªëi t∆∞·ª£ng', example: 'Êää‰π¶ÊîæÂú®Ê°åÂ≠ê‰∏ä„ÄÇ', exampleVi: 'ƒê·∫∑t s√°ch l√™n b√†n.' },
                    { type: 'choice', grammar: 'Êää', text: '‰ªñÊää‰Ωú‰∏ö___‰∫Ü„ÄÇ', hint: 'Ho√†n th√†nh b√†i t·∫≠p', options: ['ÂÅöÂÆå', 'ÂÅö', 'ÂÆå', 'ÂÅöÁùÄ'], answer: 0, explain: 'ÊääÂ≠óÂè• th∆∞·ªùng c√≥ b·ªï ng·ªØ k·∫øt qu·∫£ sau ƒë·ªông t·ª´.', example: 'ÊàëÊääÈ•≠ÂêÉÂÆå‰∫Ü„ÄÇ', exampleVi: 'T√¥i ƒë√£ ƒÉn h·∫øt c∆°m.' },
                    { type: 'fill', grammar: 'Êää', text: 'ËØ∑ÊääÁ™óÊà∑Êâì___„ÄÇ', hint: 'M·ªü c·ª≠a s·ªï', answer: 'ÂºÄ', explain: 'Êää + ÂÆæËØ≠ + Âä®ËØç + ÁªìÊûúË°•ËØ≠', example: 'ÊääÁÅØÂÖ≥Êéâ„ÄÇ', exampleVi: 'T·∫Øt ƒë√®n ƒëi.' },
                    { type: 'reorder', grammar: 'Êää', words: ['Êàë', 'Êää', 'ËøôÊú¨‰π¶', 'Áúã', 'ÂÆå', '‰∫Ü'], answer: 'ÊàëÊääËøôÊú¨‰π¶ÁúãÂÆå‰∫Ü', hint: 'ƒê·ªçc xong s√°ch', explain: '‰∏ªËØ≠ + Êää + ÂÆæËØ≠ + Âä®ËØç + Ë°•ËØ≠', example: 'Â•πÊääÊàøÈó¥ÊâìÊâ´Âπ≤ÂáÄ‰∫Ü„ÄÇ', exampleVi: 'C√¥ ·∫•y ƒë√£ d·ªçn ph√≤ng s·∫°ch s·∫Ω.' },
                    { type: 'choice', grammar: 'Êää', text: 'Âà´Êää‰∏úË•ø___Âú®ËøôÂÑø„ÄÇ', hint: 'ƒê·ª´ng ƒë·ªÉ ƒë·ªì ·ªü ƒë√¢y', options: ['Êîæ', 'Êîæ‰∫Ü', 'ÊîæÁùÄ', 'ÊîæËøá'], answer: 0, explain: 'Âà´ + ÊääÂ≠óÂè• = ƒë·ª´ng l√†m g√¨ v·ªõi ƒë·ªëi t∆∞·ª£ng', example: 'Âà´ÊääÈí±Ëä±ÂÖâ‰∫Ü„ÄÇ', exampleVi: 'ƒê·ª´ng ti√™u h·∫øt ti·ªÅn.' },
                ]
            },
            bei: {
                name: 'Ë¢´ (b√®i)', icon: 'üòÆ',
                desc: 'C√¢u b·ªã ƒë·ªông',
                exercises: [
                    { type: 'choice', grammar: 'Ë¢´', text: 'ÊàëÁöÑÊâãÊú∫___ÂÅ∑‰∫Ü„ÄÇ', hint: 'B·ªã m·∫•t c·∫Øp', options: ['Ë¢´', 'Êää', 'ËÆ©', 'Áªô'], answer: 0, explain: 'Ë¢´ + (ÊñΩ‰∫ãËÄÖ) + Âä®ËØç = b·ªã ai l√†m g√¨', example: '‰ªñË¢´ËÄÅÂ∏àÊâπËØÑ‰∫Ü„ÄÇ', exampleVi: 'Anh ·∫•y b·ªã th·∫ßy ph√™ b√¨nh.' },
                    { type: 'choice', grammar: 'Ë¢´', text: 'ËõãÁ≥ïË¢´ÂºüÂºü___‰∫Ü„ÄÇ', hint: 'B·ªã em trai ƒÉn', options: ['ÂêÉ', 'ÂêÉ‰∫Ü', 'ÂêÉÂÆå', 'ÂêÉÁùÄ'], answer: 2, explain: 'Ë¢´Â≠óÂè• th∆∞·ªùng c√≥ b·ªï ng·ªØ k·∫øt qu·∫£.', example: '‰Ωú‰∏öË¢´ÊàëÂÅöÂÆå‰∫Ü„ÄÇ', exampleVi: 'B√†i t·∫≠p ƒë√£ ƒë∆∞·ª£c t√¥i l√†m xong.' },
                    { type: 'fill', grammar: 'Ë¢´', text: 'ÈÇ£Êú¨‰π¶Ë¢´‰ªñÂÄü___‰∫Ü„ÄÇ', hint: 'B·ªã m∆∞·ª£n ƒëi', answer: 'Ëµ∞', explain: 'Ë¢´ + Âä®ËØç + Ë∂ãÂêëË°•ËØ≠', example: 'Èí±Ë¢´Â∞èÂÅ∑ÊãøËµ∞‰∫Ü„ÄÇ', exampleVi: 'Ti·ªÅn b·ªã k·∫ª tr·ªôm l·∫•y ƒëi.' },
                    { type: 'reorder', grammar: 'Ë¢´', words: ['ÊùØÂ≠ê', 'Ë¢´', 'Êàë', 'Êâì', 'Á¢é', '‰∫Ü'], answer: 'ÊùØÂ≠êË¢´ÊàëÊâìÁ¢é‰∫Ü', hint: 'C·ªëc b·ªã v·ª°', explain: 'Âèó‰∫ãËÄÖ + Ë¢´ + ÊñΩ‰∫ãËÄÖ + Âä®ËØç + Ë°•ËØ≠', example: 'Á™óÊà∑Ë¢´È£éÂêπÂºÄ‰∫Ü„ÄÇ', exampleVi: 'C·ª≠a s·ªï b·ªã gi√≥ th·ªïi m·ªü.' },
                    { type: 'choice', grammar: 'Ë¢´', text: 'Ëøô‰∏™ÈóÆÈ¢òÂ∑≤Áªè___Ëß£ÂÜ≥‰∫Ü„ÄÇ', hint: 'ƒê√£ ƒë∆∞·ª£c gi·∫£i quy·∫øt', options: ['Ë¢´', 'Êää', 'ËÆ©', 'Áªô'], answer: 0, explain: 'Ë¢´ c√≥ th·ªÉ kh√¥ng c√≥ ch·ªß ng·ªØ khi kh√¥ng c·∫ßn n√™u r√µ.', example: '‰ø°Â∑≤ÁªèË¢´ÂØÑÂá∫Âéª‰∫Ü„ÄÇ', exampleVi: 'Th∆∞ ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒëi.' },
                ]
            },
            de_complement: {
                name: 'Âæó (de)', icon: 'üìä',
                desc: 'B·ªï ng·ªØ tr√¨nh ƒë·ªô/k·∫øt qu·∫£',
                exercises: [
                    { type: 'choice', grammar: 'Âæó', text: '‰ªñËØ¥‰∏≠ÊñáËØ¥___ÂæàÂ•Ω„ÄÇ', hint: 'N√≥i t·ªët', options: ['Âæó', 'ÁöÑ', 'Âú∞', '‰∫Ü'], answer: 0, explain: 'Âä®ËØç + Âæó + ÂΩ¢ÂÆπËØç = l√†m nh∆∞ th·∫ø n√†o', example: 'Â•πÂî±Ê≠åÂî±ÂæóÂæàÂ•ΩÂê¨„ÄÇ', exampleVi: 'C√¥ ·∫•y h√°t r·∫•t hay.' },
                    { type: 'choice', grammar: 'Âæó', text: '‰ªäÂ§©ÊàëËµ∑___ÂæàÊó©„ÄÇ', hint: 'D·∫≠y s·ªõm', options: ['Âæó', 'ÁöÑ', 'Âú∞', '‰∫Ü'], answer: 0, explain: 'Âä®ËØç + Âæó + Á®ãÂ∫¶Ë°•ËØ≠', example: '‰ªñË∑ëÂæóÂæàÂø´„ÄÇ', exampleVi: 'Anh ·∫•y ch·∫°y r·∫•t nhanh.' },
                    { type: 'fill', grammar: 'Âæó', text: 'ËøôÈÅìËèúÂÅöÂæóÂ§™Âí∏___„ÄÇ', hint: 'Qu√° m·∫∑n', answer: '‰∫Ü', explain: 'Âæó + Â§™ + ÂΩ¢ÂÆπËØç + ‰∫Ü = qu√°...', example: 'Ëøô‰ª∂Ë°£ÊúçÂ§™Ë¥µ‰∫Ü„ÄÇ', exampleVi: 'C√°i √°o n√†y qu√° ƒë·∫Øt.' },
                    { type: 'reorder', grammar: 'Âæó', words: ['‰ªñ', 'Ê±âÂ≠ó', 'ÂÜô', 'Âæó', 'Âæà', 'ÊºÇ‰∫Æ'], answer: '‰ªñÊ±âÂ≠óÂÜôÂæóÂæàÊºÇ‰∫Æ', hint: 'Vi·∫øt ch·ªØ ƒë·∫πp', explain: '‰∏ªËØ≠ + ÂÆæËØ≠ + Âä®ËØç + Âæó + Ë°•ËØ≠', example: 'Â•π‰∏≠ÊñáËØ¥ÂæóÂæàÊµÅÂà©„ÄÇ', exampleVi: 'C√¥ ·∫•y n√≥i ti·∫øng Trung r·∫•t l∆∞u lo√°t.' },
                    { type: 'choice', grammar: 'Âæó', text: '‰Ω†Êù•___Â§™Êôö‰∫Ü„ÄÇ', hint: 'ƒê·∫øn mu·ªôn', options: ['Âæó', 'ÁöÑ', 'Âú∞', '‰∫Ü'], answer: 0, explain: 'Âä®ËØç + Âæó + Â§™ + ÂΩ¢ÂÆπËØç + ‰∫Ü', example: '‰ªñÂêÉÂæóÂ§™Â§ö‰∫Ü„ÄÇ', exampleVi: 'Anh ·∫•y ƒÉn qu√° nhi·ªÅu.' },
                ]
            }
        };

        // ============ STATE ============
        const state = {
            currentTopic: null,
            currentExercise: 0,
            exercises: [],
            answers: [],
            score: 0,
            streak: 0,
            totalCompleted: 0,
            totalCorrect: 0,
            userAnswer: null,
            answered: false,
            reorderAnswer: []
        };
        
        function loadStats() {
            try {
                const data = JSON.parse(localStorage.getItem('polybiz_grammar') || '{}');
                state.totalCompleted = data.completed || 0;
                state.totalCorrect = data.correct || 0;
                state.streak = data.streak || 0;
                return data.progress || {};
            } catch { return {}; }
        }
        
        function saveStats(progress) {
            localStorage.setItem('polybiz_grammar', JSON.stringify({
                completed: state.totalCompleted,
                correct: state.totalCorrect,
                streak: state.streak,
                progress
            }));
        }
        
        const topicProgress = loadStats();
        
        // ============ UI ============
        function renderTopics() {
            const grid = document.getElementById('topics-grid');
            grid.innerHTML = Object.entries(GRAMMAR_TOPICS).map(([id, topic]) => {
                const progress = topicProgress[id] || { completed: 0, correct: 0 };
                const total = topic.exercises.length;
                const pct = Math.round((progress.completed / total) * 100);
                
                return `
                    <div class="topic-card" onclick="selectTopic('${id}')">
                        <div class="topic-header">
                            <span class="topic-icon">${topic.icon}</span>
                            <span class="topic-name">${topic.name}</span>
                        </div>
                        <div class="topic-desc">${topic.desc}</div>
                        <div class="topic-progress">
                            <div class="topic-progress-fill" style="width:${pct}%"></div>
                        </div>
                        <div class="topic-stats">
                            <span>${progress.completed}/${total} c√¢u</span>
                            <span>${progress.correct > 0 ? Math.round(progress.correct/progress.completed*100) : 0}% ƒë√∫ng</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateGlobalStats();
        }
        
        function updateGlobalStats() {
            document.getElementById('stat-completed').textContent = state.totalCompleted;
            const accuracy = state.totalCompleted > 0 ? Math.round(state.totalCorrect / state.totalCompleted * 100) : 0;
            document.getElementById('stat-accuracy').textContent = accuracy + '%';
            document.getElementById('stat-streak').textContent = state.streak;
        }
        
        function selectTopic(topicId) {
            state.currentTopic = topicId;
            state.currentExercise = 0;
            state.score = 0;
            state.exercises = [...GRAMMAR_TOPICS[topicId].exercises];
            shuffleArray(state.exercises);
            state.answers = new Array(state.exercises.length).fill(null);
            
            document.getElementById('topic-screen').style.display = 'none';
            document.getElementById('exercise-screen').style.display = 'block';
            document.getElementById('results-screen').style.display = 'none';
            
            renderExerciseTabs();
            renderExercise();
        }
        
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }
        
        function renderExerciseTabs() {
            const types = { choice: 'Ch·ªçn ƒë√°p √°n', fill: 'ƒêi·ªÅn t·ª´', reorder: 'S·∫Øp x·∫øp' };
            const counts = {};
            state.exercises.forEach(e => counts[e.type] = (counts[e.type] || 0) + 1);
            
            document.getElementById('exercise-tabs').innerHTML = Object.entries(types)
                .filter(([type]) => counts[type])
                .map(([type, name]) => `
                    <button class="exercise-tab" data-type="${type}">${name} (${counts[type]})</button>
                `).join('');
        }
        
        function renderExercise() {
            const ex = state.exercises[state.currentExercise];
            state.answered = false;
            state.userAnswer = null;
            state.reorderAnswer = [];
            
            // Update header
            document.getElementById('question-number').textContent = `C√¢u ${state.currentExercise + 1}/${state.exercises.length}`;
            document.getElementById('progress-fill').style.width = `${(state.currentExercise / state.exercises.length) * 100}%`;
            
            const typeNames = { choice: 'Ch·ªçn ƒë√°p √°n', fill: 'ƒêi·ªÅn t·ª´', reorder: 'S·∫Øp x·∫øp c√¢u' };
            document.getElementById('question-type').textContent = typeNames[ex.type];
            document.getElementById('grammar-point').textContent = ex.grammar;
            document.getElementById('question-hint').textContent = 'üí° ' + ex.hint;
            
            // Render question based on type
            if (ex.type === 'choice') {
                renderChoiceQuestion(ex);
            } else if (ex.type === 'fill') {
                renderFillQuestion(ex);
            } else if (ex.type === 'reorder') {
                renderReorderQuestion(ex);
            }
            
            // Reset buttons
            document.getElementById('btn-check').style.display = 'inline-block';
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-skip').disabled = false;
            document.getElementById('explanation').classList.remove('show');
        }
        
        function renderChoiceQuestion(ex) {
            document.getElementById('question-text').innerHTML = ex.text.replace('___', '<span class="blank">?</span>');
            
            const letters = ['A', 'B', 'C', 'D'];
            document.getElementById('answer-area').innerHTML = `
                <div class="options">
                    ${ex.options.map((opt, i) => `
                        <div class="option" data-index="${i}" onclick="selectOption(${i})">
                            <div class="option-letter">${letters[i]}</div>
                            <div class="option-text">${opt}</div>
                            <div class="option-icon"></div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderFillQuestion(ex) {
            document.getElementById('question-text').innerHTML = ex.text.replace('___', '<span class="blank">?</span>');
            
            document.getElementById('answer-area').innerHTML = `
                <input type="text" class="fill-input" id="fill-input" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." 
                       onkeypress="if(event.key==='Enter')checkAnswer()">
            `;
            document.getElementById('fill-input').focus();
        }
        
        function renderReorderQuestion(ex) {
            document.getElementById('question-text').textContent = 'S·∫Øp x·∫øp c√°c t·ª´ th√†nh c√¢u ƒë√∫ng:';
            
            const shuffled = [...ex.words];
            shuffleArray(shuffled);
            
            document.getElementById('answer-area').innerHTML = `
                <div class="reorder-container target" id="answer-container" ondrop="dropWord(event)" ondragover="allowDrop(event)">
                    <span style="color:#666;">K√©o t·ª´ v√†o ƒë√¢y...</span>
                </div>
                <div class="reorder-container" id="word-bank">
                    ${shuffled.map((word, i) => `
                        <div class="word-chip" draggable="true" data-word="${word}" 
                             ondragstart="dragWord(event)" onclick="clickWord(this)">${word}</div>
                    `).join('')}
                </div>
            `;
        }
        
        function selectOption(index) {
            if (state.answered) return;
            state.userAnswer = index;
            
            document.querySelectorAll('.option').forEach((opt, i) => {
                opt.classList.toggle('selected', i === index);
            });
        }
        
        // Drag and drop for reorder
        function dragWord(e) {
            e.dataTransfer.setData('text', e.target.dataset.word);
            e.target.classList.add('dragging');
        }
        
        function allowDrop(e) {
            e.preventDefault();
        }
        
        function dropWord(e) {
            e.preventDefault();
            const word = e.dataTransfer.getData('text');
            addWordToAnswer(word);
        }
        
        function clickWord(el) {
            if (state.answered) return;
            const word = el.dataset.word;
            
            if (el.parentElement.id === 'word-bank') {
                addWordToAnswer(word);
            } else {
                removeWordFromAnswer(word);
            }
        }
        
        function addWordToAnswer(word) {
            state.reorderAnswer.push(word);
            updateReorderDisplay();
        }
        
        function removeWordFromAnswer(word) {
            const idx = state.reorderAnswer.indexOf(word);
            if (idx > -1) {
                state.reorderAnswer.splice(idx, 1);
                updateReorderDisplay();
            }
        }
        
        function updateReorderDisplay() {
            const ex = state.exercises[state.currentExercise];
            const allWords = ex.words;
            const usedWords = state.reorderAnswer;
            const remainingWords = allWords.filter(w => !usedWords.includes(w) || 
                usedWords.filter(x => x === w).length < allWords.filter(x => x === w).length);
            
            document.getElementById('answer-container').innerHTML = usedWords.length > 0 
                ? usedWords.map(w => `<div class="word-chip placed" onclick="clickWord(this)" data-word="${w}">${w}</div>`).join('')
                : '<span style="color:#666;">K√©o t·ª´ v√†o ƒë√¢y...</span>';
            
            document.getElementById('word-bank').innerHTML = remainingWords.map(w => 
                `<div class="word-chip" draggable="true" data-word="${w}" ondragstart="dragWord(event)" onclick="clickWord(this)">${w}</div>`
            ).join('');
        }
        
        function checkAnswer() {
            if (state.answered) return;
            
            const ex = state.exercises[state.currentExercise];
            let isCorrect = false;
            
            if (ex.type === 'choice') {
                if (state.userAnswer === null) {
                    alert('Vui l√≤ng ch·ªçn ƒë√°p √°n!');
                    return;
                }
                isCorrect = state.userAnswer === ex.answer;
                showChoiceResult(isCorrect, ex.answer);
            } else if (ex.type === 'fill') {
                const input = document.getElementById('fill-input');
                state.userAnswer = input.value.trim();
                if (!state.userAnswer) {
                    alert('Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi!');
                    return;
                }
                isCorrect = state.userAnswer === ex.answer;
                showFillResult(isCorrect, ex.answer);
            } else if (ex.type === 'reorder') {
                if (state.reorderAnswer.length === 0) {
                    alert('Vui l√≤ng s·∫Øp x·∫øp c√°c t·ª´!');
                    return;
                }
                state.userAnswer = state.reorderAnswer.join('');
                isCorrect = state.userAnswer === ex.answer.replace(/\s/g, '');
                showReorderResult(isCorrect, ex.answer);
            }
            
            state.answered = true;
            state.answers[state.currentExercise] = isCorrect;
            
            if (isCorrect) {
                state.score++;
                state.streak++;
                state.totalCorrect++;
            } else {
                state.streak = 0;
            }
            state.totalCompleted++;
            
            // Update topic progress
            if (!topicProgress[state.currentTopic]) {
                topicProgress[state.currentTopic] = { completed: 0, correct: 0 };
            }
            topicProgress[state.currentTopic].completed++;
            if (isCorrect) topicProgress[state.currentTopic].correct++;
            saveStats(topicProgress);
            
            updateGlobalStats();
            showExplanation(ex);
            
            document.getElementById('btn-check').style.display = 'none';
            document.getElementById('btn-next').style.display = 'inline-block';
            document.getElementById('btn-skip').disabled = true;
        }
        
        function showChoiceResult(isCorrect, correctAnswer) {
            document.querySelectorAll('.option').forEach((opt, i) => {
                opt.classList.add('disabled');
                if (i === correctAnswer) {
                    opt.classList.add('correct');
                    opt.querySelector('.option-icon').textContent = '‚úì';
                } else if (i === state.userAnswer && !isCorrect) {
                    opt.classList.add('wrong');
                    opt.querySelector('.option-icon').textContent = '‚úó';
                }
            });
        }
        
        function showFillResult(isCorrect, correctAnswer) {
            const input = document.getElementById('fill-input');
            input.classList.add(isCorrect ? 'correct' : 'wrong');
            input.disabled = true;
            
            if (!isCorrect) {
                input.value = `${state.userAnswer} ‚Üí ${correctAnswer}`;
            }
        }
        
        function showReorderResult(isCorrect, correctAnswer) {
            const container = document.getElementById('answer-container');
            container.style.borderColor = isCorrect ? '#22c55e' : '#ef4444';
            
            if (!isCorrect) {
                container.innerHTML += `<div style="width:100%;text-align:center;color:#22c55e;margin-top:10px;">
                    ƒê√°p √°n: ${correctAnswer}
                </div>`;
            }
        }
        
        function showExplanation(ex) {
            document.getElementById('explanation-text').textContent = ex.explain;
            document.getElementById('explanation-example').innerHTML = `
                <div class="example-zh">${ex.example}</div>
                <div class="example-vi">${ex.exampleVi}</div>
            `;
            document.getElementById('explanation').classList.add('show');
        }
        
        function skipQuestion() {
            state.answers[state.currentExercise] = false;
            nextQuestion();
        }
        
        function nextQuestion() {
            state.currentExercise++;
            
            if (state.currentExercise >= state.exercises.length) {
                showResults();
            } else {
                renderExercise();
            }
        }
        
        function showResults() {
            document.getElementById('exercise-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
            
            const correct = state.answers.filter(a => a === true).length;
            const total = state.exercises.length;
            const pct = Math.round(correct / total * 100);
            
            document.getElementById('results-icon').textContent = pct >= 80 ? 'üéâ' : pct >= 50 ? 'üëç' : 'üí™';
            document.getElementById('results-score').textContent = `${correct}/${total}`;
            document.getElementById('correct-count').textContent = correct;
            document.getElementById('wrong-count').textContent = total - correct;
        }
        
        function backToTopics() {
            document.getElementById('topic-screen').style.display = 'block';
            document.getElementById('exercise-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'none';
            renderTopics();
        }
        
        function restartTopic() {
            selectTopic(state.currentTopic);
        }
        
        // ============ INIT ============
        renderTopics();
    </script>
</body>
</html>
